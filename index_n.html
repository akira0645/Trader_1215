<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥‡çè¡Œå•†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&display=swap');
        
        :root {
            --bg-color: #0f1115;
            --bg-gradient-start: #1f2937;
            --bg-gradient-end: #0f1115;
            --panel-bg: rgba(30, 41, 59, 0.85); /* Darker, more glass effect */
            --border-color: rgba(255, 255, 255, 0.08);
            --accent-color: #facc15; /* Yellow */
            --accent-glow: rgba(250, 204, 21, 0.4);
            --text-main: #e5e5e5;
            --text-dim: #9ca3af;
        }

        /* æƒ¡é­”å¥‘ç´„æ¨¡å¼è®Šæ•¸ */
        body.contract-mode {
            --bg-gradient-start: #450a0a;
            --bg-gradient-end: #000000;
            --panel-bg: rgba(40, 10, 10, 0.85); /* Blood Red */
            --border-color: rgba(220, 38, 38, 0.6);
            --accent-color: #f87171; /* Light Red */
            --accent-glow: rgba(239, 68, 68, 0.7);
            --text-main: #fecaca;
        }

        body {
            font-family: 'Noto Serif TC', serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 0%, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-main);
            transition: background-image 1s ease, background-color 1s ease, color 0.5s ease;
            height: 100vh;
            overflow: hidden;
        }

        /* æ²è»¸ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        /* ç»ç’ƒæ“¬æ…‹é¢æ¿ */
        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 0 5px rgba(255,255,255,0.05); /* Inner white glow */
            transition: all 0.5s ease;
        }
        
        body.contract-mode .glass-panel {
            box-shadow: 0 0 20px var(--accent-glow), inset 0 0 8px rgba(255, 255, 255, 0.1);
        }

        .game-log {
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; 
            padding-right: 10px;
            mask-image: linear-gradient(to bottom, transparent, black 5%);
        }

        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        /* ç‰¹æ®Šæ–‡å­—æ•ˆæœ */
        .welcome-msg {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            color: var(--accent-color);
            text-shadow: 0 0 15px var(--accent-glow);
            margin: 2rem 0;
            letter-spacing: 0.1em;
            animation: zoomIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .devil-text { color: #f87171; text-shadow: 0 0 8px rgba(239, 68, 68, 0.6); font-style: italic; }
        .church-text { color: #60a5fa; text-shadow: 0 0 8px rgba(59, 130, 246, 0.6); }
        .important-text { color: var(--accent-color); font-weight: bold; }
        
        /* æ—¥èªŒä¸­çš„é«˜äº®å­—é«” */
        .game-log strong {
            color: var(--accent-color);
            text-shadow: 0 0 3px var(--accent-glow);
        }
        /* æå‡ contract-mode ä¸‹ç°è‰²æ–‡æœ¬çš„äº®åº¦ */
        body.contract-mode .game-log .text-gray-500 {
            color: #a3a3a3; /* Light Gray */
        }


        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-action {
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
            background: linear-gradient(to bottom, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .btn-action:hover:not(:disabled) {
            transform: translateY(-2px);
            border-color: var(--accent-color);
            box-shadow: 0 0 15px var(--accent-glow);
            color: var(--accent-color);
        }
        .btn-action:active:not(:disabled) { transform: translateY(1px) scale(0.98); }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }

        /* ç‰¹æ®ŠæŒ‰éˆ• (é‡‘è‰²/ç´…è‰²) */
        .btn-primary { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.4); }
        .btn-primary:hover:not(:disabled) { background: rgba(59, 130, 246, 0.4); border-color: #60a5fa; color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }

        .btn-gold { background: rgba(234, 179, 8, 0.2); border-color: rgba(234, 179, 8, 0.4); }
        .btn-gold:hover:not(:disabled) { background: rgba(234, 179, 8, 0.4); border-color: #facc15; color: white; box-shadow: 0 0 15px rgba(234, 179, 8, 0.4); }
        
        .btn-danger { background: rgba(220, 38, 38, 0.2); border-color: rgba(220, 38, 38, 0.4); }
        .btn-danger:hover:not(:disabled) { background: rgba(220, 38, 38, 0.4); border-color: #f87171; color: white; box-shadow: 0 0 15px rgba(220, 38, 38, 0.4); }
        
        /* ä¿®æ­£çš„æƒ¡é­”å¥‘ç´„æŒ‰éˆ•æ¨£å¼ */
        .btn-blood-contract {
            background-color: #3b0764 !important; /* Deep Purple/Black */
            border-color: #dc2626 !important; /* Red Border */
            color: #fef2f2 !important; /* White/Light Red Text */
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.8); /* Strong Red Glow */
            animation: pulse-red 2s infinite ease-in-out;
            transform-style: preserve-3d;
        }
        .btn-blood-contract:hover:not(:disabled) {
            background-color: #6d0a0a !important; /* Darker Red on hover */
            border-color: #f87171 !important;
            box-shadow: 0 0 30px rgba(248, 113, 113, 1);
            transform: scale(1.03) translateZ(5px);
            color: #ffcccc !important;
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 15px rgba(220, 38, 38, 0.8); }
            50% { box-shadow: 0 0 25px rgba(248, 113, 113, 1); }
        }

        /* ç‰©å“å¡ç‰‡ */
        .item-card, .intel-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: help; 
            transition: all 0.3s ease;
        }
        .item-card:hover, .intel-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent-color);
            transform: translateX(4px);
            box-shadow: -4px 0 10px -2px var(--accent-glow);
        }

        .intel-card {
            border-left: 3px solid #60a5fa;
            flex-direction: column;
            align-items: flex-start;
        }

        /* æ¨™ç±¤é  */
        .tab-btn { transition: all 0.3s; border-bottom: 2px solid transparent; opacity: 0.6; }
        .tab-btn:hover { opacity: 1; color: var(--accent-color); }
        .tab-active { 
            opacity: 1;
            color: var(--accent-color) !important; 
            border-bottom-color: var(--accent-color); 
            text-shadow: 0 0 10px var(--accent-glow);
        }

        /* æ¢ç´‹å‹•ç•«èƒŒæ™¯ (ç”¨æ–¼é«”åŠ›æ¢ç­‰) */
        .progress-bar {
            background-size: 1rem 1rem;
            background-image: linear-gradient(45deg,rgba(255,255,255,.1) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.1) 50%,rgba(255,255,255,.1) 75%,transparent 75%,transparent);
            animation: progress-stripes 2s linear infinite;
        }
        @keyframes progress-stripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }

        /* å¥‘ç´„ç°½è¨‚å¾Œçš„ç‰¹æ•ˆ */
        body.contract-mode .item-card:hover { border-color: #f87171; box-shadow: -4px 0 10px -2px rgba(248, 113, 113, 0.4); }
        body.contract-mode .tab-active { color: #f87171 !important; border-bottom-color: #f87171; text-shadow: 0 0 10px rgba(248, 113, 113, 0.5); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-200">

    <!-- Header -->
    <header class="glass-panel border-b-0 p-4 flex justify-between items-center z-10 relative">
        <div class="flex items-center gap-3">
            <div class="bg-white/5 p-2 rounded-full border border-white/10">
                <i class="fas fa-scroll text-yellow-500 text-xl" style="color: var(--accent-color);"></i>
            </div>
            <h1 class="text-xl font-bold tracking-widest uppercase" style="color: var(--text-main); text-shadow: 0 2px 5px rgba(0,0,0,0.5);">å¥‡çè¡Œå•†</h1>
        </div>
        <div class="flex gap-3 items-center">
            <div id="api-status-container" class="text-xs text-gray-400 bg-black/30 px-3 py-1 rounded-full border border-gray-700 flex items-center gap-2 shadow-inner">
                <div id="api-status-dot" class="w-2 h-2 rounded-full bg-gray-500 shadow-[0_0_5px_rgba(107,114,128,0.8)]"></div> 
                <span id="api-status-text">æ¨¡æ“¬æ¨¡å¼</span>
                <button id="btn-retry-api" onclick="confirmApiKey()" class="hidden text-blue-400 hover:text-blue-300 underline ml-1">[â†» é‡é€£]</button>
            </div>
            <button onclick="showHelpModal()" class="text-gray-400 hover:text-yellow-400 transition-all transform hover:scale-110 hover:rotate-12" title="éŠæˆ²èªªæ˜">
                <i class="fas fa-question-circle text-2xl"></i>
            </button>
        </div>
    </header>

    <!-- Main Game Area -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- Sidebar: Stats -->
        <aside class="w-1/4 glass-panel border-r-0 border-r-white/5 p-5 flex flex-col gap-5 overflow-y-auto z-10 scrollbar-hide">
            
            <!-- Character Info -->
            <div class="bg-black/30 rounded-lg p-4 border border-white/5 shadow-inner">
                <h2 class="text-xs font-bold text-gray-500 uppercase tracking-[0.2em] mb-3 pb-2 border-b border-white/5">
                    Character Status
                </h2>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between"><span class="text-gray-500">è·æ¥­:</span> <span id="char-role" class="text-white font-bold tracking-wide" style="color: var(--accent-color);">æœªå®š</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">å¤©æ•¸:</span> <span id="day-display" class="text-gray-300">ç¬¬ 1 / 5 å¤©</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">ç›®æ¨™:</span> <span class="text-green-400 font-bold font-mono">10,000 G</span></div>
                    
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div class="bg-black/20 p-2 rounded border border-white/5 text-center group hover:bg-black/40 transition-colors">
                            <div class="text-[10px] text-gray-500 mb-1 uppercase">Gold</div>
                            <div id="gold-display" class="text-yellow-400 font-bold text-lg font-mono group-hover:text-yellow-300">100 G</div>
                        </div>
                        <div class="bg-black/20 p-2 rounded border border-white/5 text-center group hover:bg-black/40 transition-colors">
                            <div class="text-[10px] text-gray-500 mb-1 uppercase">Bank</div>
                            <div id="bank-display" class="text-blue-400 font-bold text-lg font-mono group-hover:text-blue-300">0 G</div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="flex justify-between text-xs mb-1 text-gray-400"><span>é«”åŠ›</span> <span id="stamina-text">10/10</span></div>
                        <div class="w-full bg-gray-900 rounded-full h-1.5 overflow-hidden border border-white/10">
                            <div id="stamina-bar" class="h-full bg-green-500 rounded-full transition-all duration-500 progress-bar shadow-[0_0_8px_rgba(34,197,94,0.5)]" style="width: 100%"></div>
                        </div>
                    </div>

                    <div id="contract-badge" class="hidden mt-4 bg-red-900/20 border border-red-500/30 text-red-400 px-3 py-2 rounded text-center text-xs font-bold tracking-wider shadow-[0_0_15px_rgba(220,38,38,0.15)]">
                        <i class="fas fa-file-signature mr-2"></i> å·²ç°½è¨‚éˆé­‚å¥‘ç´„
                    </div>
                </div>
            </div>
            
            <!-- Attributes -->
            <div class="bg-black/30 rounded-lg p-4 border border-white/5 shadow-inner">
                <h2 class="text-xs font-bold text-gray-500 uppercase tracking-[0.2em] mb-3 pb-2 border-b border-white/5">
                    Abilities
                </h2>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center group cursor-help relative hover:bg-white/5 p-1 rounded transition-colors">
                        <span class="text-gray-400 group-hover:text-gray-200"><i class="fas fa-handshake w-5 text-center opacity-70"></i> è«‡åˆ¤æŠ€å·§</span>
                        <span class="text-white font-bold text-lg font-mono"><span id="stat-negotiation">0</span> <span id="neg-boost" class="text-xs text-green-400 hidden">(+0)</span></span>
                        <div class="absolute left-0 bottom-full mb-2 hidden group-hover:block bg-black/90 text-xs p-2 rounded border border-gray-700 z-50 whitespace-nowrap shadow-xl">å½±éŸ¿æ®ºåƒ¹æˆåŠŸç‡èˆ‡è³£å‡ºåƒ¹æ ¼</div>
                    </div>
                    <div class="flex justify-between items-center group cursor-help relative hover:bg-white/5 p-1 rounded transition-colors">
                        <span class="text-gray-400 group-hover:text-gray-200"><i class="fas fa-eye w-5 text-center opacity-70"></i> å¸‚å ´æ´å¯Ÿ</span>
                        <span class="text-white font-bold text-lg font-mono"><span id="stat-insight">0</span> <span id="ins-boost" class="text-xs text-green-400 hidden">(+0)</span></span>
                        <div class="absolute left-0 bottom-full mb-2 hidden group-hover:block bg-black/90 text-xs p-2 rounded border border-gray-700 z-50 whitespace-nowrap shadow-xl">å½±éŸ¿èƒ½å¦çœ‹åˆ°**å¸‚å ´ä¼°å€¼**ï¼Œä¸¦æé«˜æƒ…å ±å“è³ªã€‚</div>
                    </div>
                    <div class="flex justify-between items-center group cursor-help relative hover:bg-white/5 p-1 rounded transition-colors">
                        <span class="text-gray-400 group-hover:text-gray-200"><i class="fas fa-dice-d20 w-5 text-center opacity-70"></i> å‘½é‹é‹æ°£</span>
                        <span class="text-white font-bold text-lg font-mono"><span id="stat-luck">0</span> <span id="luck-boost" class="text-xs text-green-400 hidden">(+0)</span></span>
                        <div class="absolute left-0 bottom-full mb-2 hidden group-hover:block bg-black/90 text-xs p-2 rounded border border-gray-700 z-50 whitespace-nowrap shadow-xl">å½±éŸ¿è³­åšå‹ç‡èˆ‡è«‡åˆ¤é‹æ°£</div>
                    </div>
                </div>
            </div>

            <!-- Inventory & Intel -->
            <div class="bg-black/30 rounded-lg p-2 border border-white/5 shadow-inner flex-1 flex flex-col min-h-[200px]">
                <div class="flex mb-2 border-b border-white/5 pb-1">
                    <button id="btn-tab-inv" onclick="switchTab('inv')" class="flex-1 text-xs py-2 font-bold tab-btn tab-active tracking-wide">
                        <i class="fas fa-box-open mr-1"></i> èƒŒåŒ… (<span id="count-inv">0</span>)
                    </button>
                    <button id="btn-tab-intel" onclick="switchTab('intel')" class="flex-1 text-xs py-2 font-bold tab-btn tab-inactive tracking-wide">
                        <i class="fas fa-scroll mr-1"></i> æƒ…å ± (<span id="count-intel">0</span>)
                    </button>
                </div>

                <div id="tab-content-inv" class="flex-1 overflow-y-auto space-y-2 text-xs pr-1">
                    <div class="text-gray-600 text-center mt-10 italic text-xs tracking-wider">Empty Inventory</div>
                </div>

                <div id="tab-content-intel" class="hidden flex-1 overflow-y-auto space-y-2 text-xs pr-1">
                    <div class="text-gray-600 text-center mt-10 italic text-xs tracking-wider">No Intel Yet</div>
                </div>
            </div>
            
            <!-- Factions -->
            <div class="bg-black/30 rounded-lg p-4 border border-white/5 shadow-inner">
                <h2 class="text-xs font-bold text-gray-500 uppercase tracking-[0.2em] mb-3 pb-2 border-b border-white/5">
                    Reputation
                </h2>
                <div class="space-y-3 text-xs">
                     <div class="flex justify-between items-center group cursor-help relative hover:bg-white/5 p-1 rounded transition-colors">
                        <span class="text-yellow-200/70 group-hover:text-yellow-200"><i class="fas fa-coins w-4 text-center"></i> å•†æœƒ</span>
                        <div class="w-20 bg-gray-800 rounded-full h-1.5"><div id="rep-merchant-bar" class="h-full bg-yellow-500 rounded-full transition-all duration-500" style="width: 50%"></div></div>
                        <span id="rep-merchant-val" class="w-5 text-right font-mono">0</span>
                        <div class="absolute left-0 bottom-full mb-2 hidden group-hover:block bg-black/90 text-xs p-2 rounded border border-gray-700 z-50 shadow-xl">å½±éŸ¿å•†æœƒåƒ¹æ ¼èˆ‡å­˜æ¬¾å„ªæƒ </div>
                    </div>
                    <div class="flex justify-between items-center group cursor-help relative hover:bg-white/5 p-1 rounded transition-colors">
                        <span class="text-blue-200/70 group-hover:text-blue-200"><i class="fas fa-cross w-4 text-center"></i> æ•™æœƒ</span>
                        <div class="w-20 bg-gray-800 rounded-full h-1.5"><div id="rep-church-bar" class="h-full bg-blue-500 rounded-full transition-all duration-500" style="width: 50%"></div></div>
                        <span id="rep-church-val" class="w-5 text-right font-mono">0</span>
                        <div class="absolute left-0 bottom-full mb-2 hidden group-hover:block bg-black/90 text-xs p-2 rounded border border-gray-700 z-50 shadow-xl">å½±éŸ¿è–å…‰æ•™å ‚åƒ¹æ ¼èˆ‡åŠ‡æƒ…</div>
                    </div>
                    <div class="flex justify-between items-center group cursor-help relative hover:bg-white/5 p-1 rounded transition-colors">
                        <span class="text-red-300/70 group-hover:text-red-300"><i class="fas fa-skull w-4 text-center"></i> é­”ç•Œ</span>
                        <div class="w-20 bg-gray-800 rounded-full h-1.5"><div id="rep-demon-bar" class="h-full bg-red-600 rounded-full transition-all duration-500" style="width: 50%"></div></div>
                        <span id="rep-demon-val" class="w-5 text-right font-mono">0</span>
                        <div class="absolute left-0 bottom-full mb-2 hidden group-hover:block bg-black/90 text-xs p-2 rounded border border-gray-700 z-50 shadow-xl">å½±éŸ¿é»‘å¸‚åƒ¹æ ¼èˆ‡è³­å ´</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col relative bg-transparent">
            <!-- Game Log -->
            <div id="game-log" class="game-log flex-1 p-8 space-y-6 shadow-inner">
                <div class="welcome-msg">æ­¡è¿ä¾†åˆ°ã€Šå¥‡çè¡Œå•†ã€‹</div>
                <div class="text-gray-500 text-center italic text-sm tracking-widest opacity-70">è«‹é¸æ“‡ä½ çš„å‡ºèº«...</div>
            </div>

            <!-- Input / Action Area -->
            <div id="action-area" class="h-auto min-h-[30%] glass-panel border-t border-t-white/10 p-6 flex flex-col gap-4 z-20 transition-all duration-300">
                <div id="controls" class="flex flex-wrap gap-3 justify-center h-full items-center content-center overflow-auto p-2">
                    <button class="btn-action bg-gradient-to-r from-blue-700 to-blue-600 hover:from-blue-600 hover:to-blue-500 text-white font-bold py-4 px-12 rounded-lg shadow-xl text-xl tracking-[0.2em] transform hover:-translate-y-1 transition-all duration-300 border border-blue-400/30" onclick="showApiKeyModal()">
                        <i class="fas fa-play mr-2"></i>é–‹å§‹æ—…ç¨‹
                    </button>
                </div>
                <!-- Hidden Inputs -->
                <div id="slider-container" class="hidden w-full max-w-lg mx-auto bg-black/40 p-4 rounded-lg border border-gray-600 backdrop-blur-sm shadow-2xl">
                    <div class="flex justify-between text-base text-gray-300 mb-4"><span id="slider-label" class="font-bold">é‡‘é¡</span><span id="slider-val-display" class="text-yellow-400 font-bold font-mono text-xl">0</span></div>
                    <input type="range" id="amount-slider" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" min="1" max="100" value="1">
                    <div class="flex justify-between mt-6">
                        <button id="btn-slider-cancel" class="text-sm bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded text-gray-300 transition-colors">å–æ¶ˆ</button>
                        <button id="btn-slider-confirm" class="text-sm bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 px-8 py-2 rounded text-white font-bold shadow-lg transition-transform transform hover:-translate-y-0.5">ç¢ºèª</button>
                    </div>
                </div>
                <div id="input-container" class="hidden w-full max-w-3xl mx-auto">
                    <div id="preset-options" class="flex gap-2 justify-center mb-1 overflow-x-auto pb-2 scrollbar-thin"></div>
                    <div class="flex gap-2">
                        <input type="text" id="player-input" class="flex-1 bg-black/40 border border-gray-600 text-white px-5 py-3 rounded-lg focus:outline-none focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500 placeholder-gray-500 transition-all font-serif" placeholder="è¼¸å…¥ä½ çš„å›æ‡‰...">
                        <button id="submit-input" class="bg-gradient-to-b from-yellow-600 to-yellow-700 hover:from-yellow-500 hover:to-yellow-600 text-white px-8 py-3 rounded-lg font-bold shadow-md transition-all border border-yellow-500/30">ç™¼é€</button>
                    </div>
                </div>
            </div>

            <!-- Location Overlay -->
            <div id="location-name" class="absolute top-6 right-6 bg-black/60 backdrop-blur-md px-6 py-3 rounded-r-lg text-white font-serif text-2xl border-l-4 border-yellow-500 shadow-xl tracking-widest transform transition-all opacity-0 duration-500" style="right: -10px;">
                å‘½é‹çš„åå­—è·¯å£
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="api-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden fade-in">
        <div class="bg-gray-800 border border-gray-600 rounded-xl max-w-md w-full p-8 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>
            <h2 class="text-2xl font-bold text-white mb-2 text-center font-serif tracking-wide">ç³»çµ±è¨­å®š</h2>
            <p class="text-gray-400 text-sm mb-6 text-center leading-relaxed">è«‹è¼¸å…¥ Gemini API Key (é¸å¡«) ä»¥å•Ÿç”¨ AIã€‚<br>ç›´æ¥é€²å…¥å°‡ä½¿ç”¨æ¨¡æ“¬è³‡æ–™ã€‚</p>
            <input type="password" id="modal-api-input" class="w-full bg-black/30 border border-gray-600 text-white px-4 py-3 rounded-lg mb-6 focus:outline-none focus:border-blue-500 transition-colors font-mono text-sm" placeholder="API Key...">
            <button onclick="confirmApiKey()" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold py-3 rounded-lg shadow-lg transform transition hover:-translate-y-1">é€²å…¥ç•°ä¸–ç•Œ</button>
            <div class="text-center mt-4"><a href="#" onclick="initGameWithMock()" class="text-xs text-gray-500 hover:text-gray-300 underline transition-colors">è·³é (ä½¿ç”¨æ¨¡æ“¬è³‡æ–™)</a></div>
        </div>
    </div>

    <div id="help-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-gray-900 border border-gray-600 rounded-xl max-w-3xl w-full p-0 shadow-2xl relative flex flex-col max-h-[85vh]">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center bg-black/20 rounded-t-xl">
                <h2 class="text-2xl font-bold text-yellow-500 font-serif tracking-wide"><i class="fas fa-book-open mr-2"></i> å†’éšªæŒ‡å—</h2>
                <button onclick="document.getElementById('help-modal').classList.add('hidden')" class="text-gray-400 hover:text-white transition-colors"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-8 overflow-y-auto space-y-8 text-sm text-gray-300 leading-relaxed font-serif">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-bold text-white text-lg mb-3 pb-1 border-b border-gray-700"><i class="fas fa-trophy mr-2 text-yellow-500"></i> å‹åˆ©æ¢ä»¶</h3>
                        <p>æ‚¨çš„ç›®æ¨™æ˜¯åœ¨ <span class="text-yellow-400 font-bold">5 å¤©</span> å…§è³ºå– <span class="text-green-400 font-bold">10,000 G</span> ä¸¦å­˜æ´»ä¸‹ä¾†ã€‚</p>
                    </div>
                    <div>
                        <h3 class="font-bold text-white text-lg mb-3 pb-1 border-b border-gray-700"><i class="fas fa-bolt mr-2 text-blue-500"></i> é«”åŠ›èˆ‡ç”Ÿå­˜</h3>
                        <p>ç§»å‹•(-1)ã€äº¤æ˜“(-2)ã€æ‰“æ¢(-1)ã€‚æ¯æ™šéœ€æ”¯ä»˜ <span class="text-red-400 font-bold">ç”Ÿæ´»è²»</span>ã€‚é«”åŠ›è€—ç›¡ç„¡æ³•è¡Œå‹•ã€‚</p>
                    </div>
                </div>
                
                <div>
                    <h3 class="font-bold text-white text-lg mb-3 pb-1 border-b border-gray-700"><i class="fas fa-balance-scale mr-2 text-purple-400"></i> äº¤æ˜“èˆ‡è²æœ›</h3>
                    <p class="mb-2">è²æœ›æœƒå½±éŸ¿<span class="text-yellow-400">åŠ‡æƒ…èµ°å‘</span>ã€è²·è³£åƒ¹æ ¼èˆ‡ NPC æ…‹åº¦ã€‚</p>
                    <ul class="space-y-2 ml-2">
                        <li class="flex items-center gap-2"><span class="bg-green-900/30 text-green-400 px-2 py-0.5 rounded text-xs border border-green-500/30">äº¤æ˜“æˆåŠŸ</span> è²æœ› +1</li>
                        <li class="flex items-center gap-2"><span class="bg-red-900/30 text-red-400 px-2 py-0.5 rounded text-xs border border-red-500/30">äº¤æ˜“å–æ¶ˆ/å¤±æ•—</span> è²æœ› -1</li>
                        <li class="flex items-center gap-2"><span class="bg-blue-900/30 text-blue-400 px-2 py-0.5 rounded text-xs border border-blue-500/30">æ‰“æ¢æƒ…å ±è¢«æŠ“</span> è²æœ› -2</li>
                    </ul>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-bold text-white text-lg mb-3 pb-1 border-b border-gray-700"><i class="fas fa-coins mr-2 text-yellow-200"></i> é‡‘èè¨­æ–½</h3>
                        <ul class="space-y-2">
                            <li><strong class="text-yellow-200">éŠ€è¡Œ</strong>ï¼šå­˜å…¥è³‡é‡‘å¯ç”Ÿæ¯ (æ¯æ—¥æµ®å‹• 2%~8%)ï¼Œå­˜å…¥æ™‚éœ€æ”¯ä»˜æ‰‹çºŒè²» 10 Gã€‚</li>
                            <li><strong class="text-purple-400">è³­å ´</strong>ï¼šåœ°ä¸‹é»‘å¸‚æä¾›ç¿»å€çš„æ©Ÿæœƒã€‚ä½†è‹¥ç°½è¨‚äº†æƒ¡é­”å¥‘ç´„ï¼Œé¢¨éšªæ¥µé«˜ã€‚</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-white text-lg mb-3 pb-1 border-b border-gray-700"><i class="fas fa-box mr-2 text-blue-300"></i> ç‰©å“åŠŸèƒ½</h3>
                        <ul class="space-y-1 text-gray-400">
                            <li><span class="text-blue-300">ğŸ—£ï¸ äº¤æ¶‰</span>ï¼šæå‡è«‡åˆ¤æŠ€å·§ã€‚</li>
                            <li><span class="text-purple-300">ğŸ‘ï¸ æ´å¯Ÿ</span>ï¼šæå‡å°ç‰©å“åƒ¹å€¼çš„åˆ¤æ–·ã€‚</li>
                            <li><span class="text-green-300">ğŸ€ å¹¸é‹</span>ï¼šæå‡è³­å ´å‹ç‡èˆ‡è«‡åˆ¤é‹æ°£ã€‚</li>
                            <li><span class="text-yellow-300">ğŸ“œ æƒ…å ±</span>ï¼šç²å¾—å¸‚å ´è³‡è¨Šã€‚</li>
                        </ul>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-red-900/20 to-transparent p-5 rounded-lg border-l-4 border-red-600">
                    <h3 class="font-bold text-red-400 text-lg mb-2"><i class="fas fa-file-signature mr-2"></i> æƒ¡é­”å¥‘ç´„</h3>
                    <p class="italic text-gray-400">ã€Œç•¶ä½ å‡è¦–æ·±æ·µæ™‚ï¼Œæ·±æ·µä¹Ÿåœ¨å‡è¦–ä½ ...ã€</p>
                    <p class="mt-2">ç¼ºéŒ¢æ™‚æƒ¡é­”æœƒæä¾›æ•‘å‘½è³‡é‡‘ã€‚ä»£åƒ¹æ˜¯ç”Ÿæ´»è²»ç¿»å€ã€è«‡åˆ¤è®Šé›£ï¼Œä¸”å†æ¬¡ç ´ç”¢å°‡ç›´æ¥ç»ç¥­éˆé­‚ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Modal (Devil Contract) -->
    <div id="event-modal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-gray-800 border-2 border-red-800/80 rounded-xl max-w-2xl w-full p-8 shadow-[0_0_100px_rgba(220,38,38,0.3)] relative overflow-hidden transform scale-100 transition-transform">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] opacity-30 pointer-events-none mix-blend-overlay"></div>
            <div class="absolute -top-10 -right-10 w-40 h-40 bg-red-600/20 blur-3xl rounded-full pointer-events-none"></div>
            <h2 id="modal-title" class="text-4xl font-bold text-red-500 mb-6 font-serif text-center tracking-widest" style="text-shadow: 0 0 15px rgba(220, 38, 38, 0.8);"></h2>
            <div id="modal-content" class="text-gray-300 text-lg leading-relaxed mb-10 text-center space-y-4 font-serif relative z-10"></div>
            <!-- ACTIONS are customized in JS, including the blood contract button -->
            <div id="modal-actions" class="flex justify-center gap-6 relative z-10"></div>
        </div>
    </div>

    <script>
        let API_KEY = "";
        
        let gameState = {
            day: 1,
            maxDays: 5,
            gold: 0,
            bank: 0,
            goal: 10000, 
            livingCost: 100,
            stamina: 10, 
            maxStamina: 10, 
            attributes: { negotiation: 0, insight: 0, luck: 0 },
            luckBoost: 0, 
            reputation: { merchant: 0, church: 0, demon: 0 },
            inventory: [],
            location: "start",
            contractSigned: false,
            isPurified: false, // New Flag for hidden sin
            gameOver: false,
            npcCurrent: null, 
            pendingPurchase: null,
            pendingBetAmount: null, 
            forcedGamble: false,
            marketModifiers: {},
            quizHistory: [],
            bgStory: "", 
            role: "æœªå®š",
            lastIntelRumor: "",
            interestRate: 0.05,
            isProcessing: false // æ–°å¢å…¨å±€è™•ç†æ——æ¨™
        };

        const FACTION_NAMES = { 'merchant': 'å•†æœƒ', 'church': 'æ•™æœƒ', 'demon': 'é­”ç•Œ' };
        const MAX_LOAN_CAP = 5000; 

        const LOCATIONS = {
            "merchant_guild": { name: "é»ƒé‡‘å•†æœƒ", color: "text-yellow-400", desc: "å¤§é™¸æœ€å¤§çš„è²¿æ˜“ä¸­å¿ƒï¼Œé‡‘å¹£æµå‹•çš„è²éŸ³æ—¥å¤œä¸æ¯ã€‚", faction: "merchant" },
            "church_district": { name: "è–å…‰æ•™å ‚", color: "text-blue-400", desc: "å®å‰çš„å°–å¡”ç›´æŒ‡å¤©éš›ï¼Œå½©ç¹ªç»ç’ƒæŠ˜å°„å‡ºä¸ƒè‰²è–å…‰ã€‚ä¿¡å¾’å€‘åœ¨æ­¤è™”èª ç¥ˆç¦±ï¼Œç©ºæ°£ä¸­ç€°æ¼«è‘—ä»¤äººå¿ƒå®‰çš„è–°é¦™æ°£æ¯ã€‚", faction: "church" },
            "black_market": { name: "åœ°ä¸‹é»‘å¸‚", color: "text-purple-400", desc: "ä½æ–¼åŸå¸‚ä¸‹æ°´é“çš„é™°æš—è§’è½ï¼Œåªæœ‰æ‡‚è¦çŸ©çš„äººæ‰èƒ½åœ¨é€™è£¡ç”Ÿå­˜ã€‚", faction: "demon" }
        };

        const LUCKY_ITEMS = ["æƒ¡é­”çš„æ–·æŒ‡", "å¹¸é‹å…”è…³", "å—ç¥ç¦çš„è–æ°´", "ç™¼å…‰çš„ç¨®å­"];

        const NPCS = [
            { name: "è²ªå©ªçš„å“¥å¸ƒæ—", race: "Goblin", role: "Merchant", personality: "Greedy", desc: "ä¸€éš»çœ¼ç¥é–ƒçˆçš„å“¥å¸ƒæ—ï¼Œæ“è‘—æ‰‹çœ‹è‘—ä½ ã€‚", faction: "demon" },
            { name: "é«˜å‚²çš„ç²¾éˆ", race: "Elf", role: "Alchemist", personality: "Arrogant", desc: "é›–ç„¶åœ¨è³£æ±è¥¿ï¼Œä½†ä»–çœ‹ä½ çš„çœ¼ç¥åƒæ˜¯åœ¨çœ‹åƒåœ¾ã€‚", faction: "church" },
            { name: "è½é­„çš„é¨å£«", race: "Human", role: "Guard", personality: "Honest", desc: "ç›”ç”²ç”Ÿé½äº†ï¼Œç‚ºäº†ç”Ÿè¨ˆä¸å¾—ä¸è®Šè³£å®¶ç”¢ã€‚", faction: "merchant" }
        ];

        const ITEM_TEMPLATES = [
            { name: "ç¦®å„€æ‰‹å†Š", type: 'negotiation', boost: 1, basePrice: 200, trueValue: 300, desc: "ä¸€æœ¬æ•™ä½ å¦‚ä½•å„ªé›…ç½µäººçš„æ›¸ã€‚" },
            { name: "æ”¾å¤§é¡", type: 'insight', boost: 1, basePrice: 300, trueValue: 400, desc: "èƒ½çœ‹åˆ°å¾®å°çš„ç‘•ç–µã€‚" },
            { name: "å¹¸é‹é‡‘å¹£", type: 'luck', boost: 1, basePrice: 500, trueValue: 600, desc: "æ“šèªªæ˜¯è¢«å¹¸é‹å¥³ç¥è¦ªå»éçš„é‡‘å¹£ã€‚" },
            { name: "å•†æœƒå¯†å‡½", type: 'intel', boost: 0, basePrice: 150, trueValue: 200, desc: "è£¡é¢è¨˜è¼‰è‘—æŸäº›ä¸ç‚ºäººçŸ¥çš„ç§˜å¯†ã€‚" },
            { name: "é‘²é‡‘èˆŒé ­", type: 'negotiation', boost: 1.5, basePrice: 600, trueValue: 800, desc: "å¤ä»£è¾¯è«–å®¶çš„éºç‰©ã€‚" },
            { name: "çœŸè¦–ä¹‹çœ¼", type: 'insight', boost: 1.5, basePrice: 700, trueValue: 900, desc: "èƒ½çœ‹ç©¿ä¸€åˆ‡è¬Šè¨€çš„æ°´æ™¶ã€‚" },
            { name: "å…”è…³", type: 'luck', boost: 0.5, basePrice: 150, trueValue: 200, desc: "æ™®é€šçš„å¹¸é‹è­·ç¬¦ã€‚" }
        ];

        const NEGOTIATION_PRESETS = [
            "é€™æ±è¥¿ä¸Šé¢æœ‰æ˜é¡¯çš„åˆ®ç—•ï¼Œä¾¿å®œé»å§ï¼Ÿ",
            "éš”å£æ”¤ä½è³£å¾—æ¯”ä½ ä¾¿å®œå¤šäº†ã€‚",
            "æˆ‘æ˜¯èª å¿ƒæƒ³è²·ï¼Œäº¤å€‹æœ‹å‹ä»¥å¾Œå¸¸ä¾†ã€‚",
            "ç¾åœ¨è¡Œæƒ…ä¸å¥½ï¼Œé€™æ±è¥¿å¾ˆé›£è„«æ‰‹å§ï¼Ÿ"
        ];

        const TYPE_ICONS = { 
            'negotiation': '<i class="fas fa-handshake"></i>', 
            'insight': '<i class="fas fa-eye"></i>', 
            'luck': '<i class="fas fa-dice"></i>', 
            'intel': '<i class="fas fa-scroll"></i>' 
        };
        const TYPE_TRANSLATIONS = { 'negotiation': 'äº¤æ¶‰', 'insight': 'æ´å¯Ÿ', 'luck': 'å¹¸é‹', 'intel': 'æƒ…å ±' };
        
        // --- è¼”åŠ©å‡½æ•¸: é˜²å‘†æ§åˆ¶ ---
        function startProcessing() {
            gameState.isProcessing = true;
            ui.controls.style.pointerEvents = 'none';
            ui.controls.style.opacity = '0.6';
        }

        function stopProcessing() {
            gameState.isProcessing = false;
            ui.controls.style.pointerEvents = 'auto';
            ui.controls.style.opacity = '1';
        }

        // --- API & AI Helper ---
        async function callGemini(prompt, jsonMode = false) {
            if (!API_KEY) return null; 
            // ç”±æ–¼ä¹‹å‰çš„éŒ¯èª¤ï¼Œæˆ‘å€‘å°‡è¶…æ™‚æ™‚é–“è¨­ç½®å¾—æ›´é•·ä¸€äº›ï¼ˆ15ç§’ï¼‰
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            if (jsonMode) payload.generationConfig = { responseMimeType: "application/json" };

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); 

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error("API Call Failed");
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) {
                clearTimeout(timeoutId);
                console.error("Gemini API Error:", error);
                API_KEY = "";
                ui.apiStatus.innerHTML = `<div class="w-2 h-2 rounded-full bg-red-500"></div> é€£ç·šä¸­æ–· (è½‰æ¨¡æ“¬)`;
                document.getElementById('btn-retry-api').classList.remove('hidden');
                return null;
            }
        }

        // --- UI Functions ---
        const ui = {
            log: document.getElementById('game-log'),
            gold: document.getElementById('gold-display'),
            bank: document.getElementById('bank-display'),
            day: document.getElementById('day-display'),
            stamina: document.getElementById('stamina-bar'),
            staminaText: document.getElementById('stamina-text'),
            role: document.getElementById('char-role'),
            controls: document.getElementById('controls'),
            inputContainer: document.getElementById('input-container'),
            sliderContainer: document.getElementById('slider-container'),
            presetOptions: document.getElementById('preset-options'),
            locName: document.getElementById('location-name'),
            invList: document.getElementById('tab-content-inv'),
            intelList: document.getElementById('tab-content-intel'),
            apiStatus: document.getElementById('api-status-container'),
            statNeg: document.getElementById('stat-negotiation'),
            statIns: document.getElementById('stat-insight'),
            statLuck: document.getElementById('stat-luck'),
            boostNeg: document.getElementById('neg-boost'),
            boostIns: document.getElementById('ins-boost'),
            boostLuck: document.getElementById('luck-boost'),
            reps: { merV: document.getElementById('rep-merchant-val'), chuV: document.getElementById('rep-church-val'), demV: document.getElementById('rep-demon-val') }
        };

        function showApiKeyModal() { document.getElementById('api-modal').classList.remove('hidden'); }
        function showHelpModal() { document.getElementById('help-modal').classList.remove('hidden'); }
        function initGameWithMock() {
            API_KEY = "";
            document.getElementById('api-status-dot').className = "w-2 h-2 rounded-full bg-gray-500";
            document.getElementById('api-status-text').innerText = "æ¨¡æ“¬æ¨¡å¼";
            document.getElementById('api-modal').classList.add('hidden');
            initGame();
        }

        async function confirmApiKey() {
            const input = document.getElementById('modal-api-input').value.trim();
            let keyToUse = input || API_KEY;
            
            if (keyToUse) {
                API_KEY = keyToUse;
                document.getElementById('api-status-dot').className = "w-2 h-2 rounded-full bg-yellow-500 animate-pulse";
                document.getElementById('api-status-text').innerText = "é€£ç·šæ¸¬è©¦ä¸­...";
                document.getElementById('btn-retry-api').classList.add('hidden');
                
                const test = await callGemini("test");
                if (test) {
                    document.getElementById('api-status-dot').className = "w-2 h-2 rounded-full bg-green-500";
                    document.getElementById('api-status-text').innerText = "AI é€£ç·šä¸­";
                } else {
                    API_KEY = "";
                    document.getElementById('api-status-dot').className = "w-2 h-2 rounded-full bg-red-500";
                    document.getElementById('api-status-text').innerText = "é€£ç·šå¤±æ•—";
                    document.getElementById('btn-retry-api').classList.remove('hidden');
                }
            } else {
                initGameWithMock();
                return;
            }
            document.getElementById('api-modal').classList.add('hidden');
            if(gameState.role === "æœªå®š") initGame(); 
        }

        function switchTab(tab) {
            const invBtn = document.getElementById('btn-tab-inv');
            const intelBtn = document.getElementById('btn-tab-intel');
            const invContent = document.getElementById('tab-content-inv');
            const intelContent = document.getElementById('tab-content-intel');
            if (tab === 'inv') {
                invContent.classList.remove('hidden'); intelContent.classList.add('hidden');
                invBtn.classList.add('tab-active'); invBtn.classList.remove('tab-inactive');
                intelBtn.classList.add('tab-inactive'); intelBtn.classList.remove('tab-active');
            } else {
                invContent.classList.add('hidden'); intelContent.classList.remove('hidden');
                intelBtn.classList.add('tab-active'); intelBtn.classList.remove('tab-inactive');
                invBtn.classList.add('tab-inactive'); invBtn.classList.remove('tab-active');
            }
        }

        function addLog(text, type = 'normal') {
            const div = document.createElement('div');
            div.className = "fade-in mb-3 leading-relaxed";
            if (type === 'system') div.className += " text-gray-500 text-sm border-l-2 border-gray-600 pl-3 border-l-gray-700";
            else if (type === 'important') div.className += " text-yellow-300 font-bold border-l-2 border-yellow-500 pl-3 bg-yellow-500/10 py-1";
            else if (type === 'danger') div.className += " devil-text font-bold border-l-2 border-red-500 pl-3 bg-red-900/20 py-1";
            else if (type === 'npc') div.className += " text-cyan-300 border-l-2 border-cyan-500 pl-3";
            else if (type === 'player') div.className += " text-green-400 text-right italic pr-2";
            else if (type === 'story') div.className += " text-purple-300 italic border-l-4 border-purple-500 pl-4 py-2 bg-purple-900/20 story-content rounded-r border-t border-b border-r border-purple-500/30";
            else if (type === 'church-text') div.className += " church-text font-bold border-l-2 border-blue-500 pl-3 bg-blue-900/20 py-1";
            else div.className += " text-gray-300";

            if (type !== 'story') text = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-yellow-400">$1</strong>');
            div.innerHTML = text;
            ui.log.prepend(div); 
        }

        function addDevilComment(action) {
            // Even if purified, the demon still mocks you, maybe more sinisterly
            if ((!gameState.contractSigned && !gameState.isPurified) || Math.random() > 0.3) return;
            
            let list = [];
            if (gameState.isPurified) {
                list = ["ä½ ä»¥ç‚ºæ´—å¾—æ‰å—ï¼Ÿ", "è–å…‰ä¸‹çš„å½±å­æ›´æ·±...", "ä»–å€‘ä¹Ÿæ”¶äº†æˆ‘çš„éŒ¢..."];
            } else {
                const comments = {
                    'trade': ["ä½ çš„è²ªå©ªæ»‹å‘³çœŸä¸éŒ¯...", "éˆé­‚çš„é‡é‡ä¼¼ä¹æ¸›è¼•äº†å‘¢...", "é€™ç­†äº¤æ˜“ï¼Œæˆ‘ä¹Ÿæœ‰ä¸€ä»½å§ï¼Ÿ"],
                    'move': ["ç„¡è«–é€ƒåˆ°å“ªè£¡ï¼Œå½±å­éƒ½è·Ÿè‘—ä½ ...", "ä½ ä»¥ç‚ºä½ èƒ½é‚„æ¸…å—ï¼Ÿå˜»å˜»...", "æ™‚é–“ä¸å¤šäº†..."],
                    'gamble': ["å†è³­å¤§ä¸€é»ï¼ŒæŠŠéˆé­‚ä¹ŸæŠ¼ä¸Šï¼", "è¼¸å§ï¼Œè¼¸å…‰äº†å°±å±¬æ–¼æˆ‘äº†...", "å¹¸é‹å¥³ç¥ï¼Ÿå¥¹æ—©å°±æ‹‹æ£„ä½ äº†ã€‚"]
                };
                list = comments[action] || comments['move'];
            }
            addLog(`æƒ¡é­”ä½èª: ã€${list[Math.floor(Math.random()*list.length)]}ã€`, "devil-text");
        }

        function updateUI() {
            // Apply Contract Theme
            if (gameState.contractSigned) {
                document.body.classList.add('contract-mode');
            } else {
                document.body.classList.remove('contract-mode');
            }

            let luckBonus = 0, negBoost = 0, insBoost = 0;
            gameState.inventory.forEach(item => {
                if (item.type === 'luck') luckBonus += (item.boost || 0);
                if (item.type === 'negotiation') negBoost += (item.boost || 0);
                if (item.type === 'insight') insBoost += (item.boost || 0);
            });
            gameState.luckBoost = parseFloat(luckBonus.toFixed(1));

            ui.gold.innerText = Math.floor(gameState.gold).toLocaleString() + " G";
            ui.bank.innerText = Math.floor(gameState.bank).toLocaleString() + " G";
            ui.day.innerText = `ç¬¬ ${gameState.day} / ${gameState.maxDays} å¤©`;
            ui.role.innerText = gameState.role || "æœªå®š";
            
            const staminaPct = (gameState.stamina / gameState.maxStamina) * 100;
            ui.stamina.style.width = `${staminaPct}%`;
            // Color shift based on value
            if (gameState.stamina < 5) ui.stamina.className = `h-full rounded-full transition-all duration-300 bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)] progress-bar`;
            else ui.stamina.className = `h-full rounded-full transition-all duration-300 bg-gradient-to-r from-green-500 to-emerald-400 shadow-[0_0_10px_rgba(16,185,129,0.3)] progress-bar`;
            ui.staminaText.innerText = `${gameState.stamina}/${gameState.maxStamina}`;

            ui.statNeg.innerText = gameState.attributes.negotiation;
            if(negBoost > 0) { ui.boostNeg.innerText = `(+${negBoost.toFixed(1)})`; ui.boostNeg.classList.remove('hidden'); } else ui.boostNeg.classList.add('hidden');
            ui.statIns.innerText = gameState.attributes.insight;
            if(insBoost > 0) { ui.boostIns.innerText = `(+${insBoost.toFixed(1)})`; ui.boostIns.classList.remove('hidden'); } else ui.boostIns.classList.add('hidden');
            ui.statLuck.innerText = gameState.attributes.luck;
            if(luckBonus > 0) { ui.boostLuck.innerText = `(+${luckBonus.toFixed(1)})`; ui.boostLuck.classList.remove('hidden'); } else ui.boostLuck.classList.add('hidden');

            // Normalized widths for rep bars (0-100%) assuming max rep ~20 for visuals
            const repM = Math.min(100, Math.max(0, (gameState.reputation.merchant + 10) * 3));
            const repC = Math.min(100, Math.max(0, (gameState.reputation.church + 10) * 3));
            const repD = Math.min(100, Math.max(0, (gameState.reputation.demon + 10) * 3));
            
            document.getElementById('rep-merchant-bar').style.width = `${repM}%`;
            document.getElementById('rep-church-bar').style.width = `${repC}%`;
            document.getElementById('rep-demon-bar').style.width = `${repD}%`;

            ui.reps.merV.innerText = gameState.reputation.merchant;
            ui.reps.chuV.innerText = gameState.reputation.church;
            ui.reps.demV.innerText = gameState.reputation.demon;

            if (gameState.contractSigned) document.getElementById('contract-badge').classList.remove('hidden');
            else document.getElementById('contract-badge').classList.add('hidden');

            const normalItems = gameState.inventory.filter(i => i.type !== 'intel');
            const intelItems = gameState.inventory.filter(i => i.type === 'intel');
            document.getElementById('count-inv').innerText = normalItems.length;
            document.getElementById('count-intel').innerText = intelItems.length;

            ui.invList.innerHTML = '';
            if (normalItems.length === 0) ui.invList.innerHTML = '<div class="text-gray-600 text-center mt-10 italic text-xs tracking-wider">Empty Inventory</div>';
            else {
                normalItems.forEach(item => {
                    const el = document.createElement('div');
                    el.className = "item-card";
                    let typeIcon = TYPE_ICONS[item.type];
                    let boostLabel = "";
                    if(item.type === 'negotiation') { boostLabel = `è«‡åˆ¤ +${item.boost}`; }
                    if(item.type === 'insight') { boostLabel = `æ´å¯Ÿ +${item.boost}`; }
                    if(item.type === 'luck') { boostLabel = `é‹æ°£ +${item.boost}`; }
                    
                    el.title = `${item.desc}\næ•ˆæœ: ${boostLabel}`;
                    el.innerHTML = `<div class="flex items-center gap-2"><span class="text-lg">${typeIcon}</span> <span class="text-gray-200 font-bold">${item.name}</span></div><span class="text-yellow-500 text-xs font-mono bg-black/40 px-2 py-1 rounded">ä¼°å€¼: ${item.trueValue} G</span>`;
                    ui.invList.appendChild(el);
                });
            }

            ui.intelList.innerHTML = '';
            if (intelItems.length === 0) ui.intelList.innerHTML = '<div class="text-gray-600 text-center mt-10 italic text-xs tracking-wider">No Intel Yet</div>';
            else {
                intelItems.forEach(item => {
                    const el = document.createElement('div');
                    el.className = "intel-card";
                    el.title = item.desc; 
                    // ä¿®æ­£é» 2: åªé¡¯ç¤º summaryï¼Œå°‡ desc ç•™çµ¦ hover (title)
                    el.innerHTML = `<div class="font-bold text-blue-300 mb-1 w-full truncate border-b border-blue-500/30 pb-1">${item.summary}</div>`; 
                    ui.intelList.appendChild(el);
                });
            }
            
            // Location Name Animation
            const locEl = ui.locName;
            locEl.classList.remove('translate-x-full', 'opacity-0');
            if (LOCATIONS[gameState.location]) locEl.innerText = LOCATIONS[gameState.location].name;
        }

        function clearControls() {
            ui.controls.innerHTML = '';
            ui.inputContainer.classList.add('hidden');
            ui.sliderContainer.classList.add('hidden');
            ui.presetOptions.innerHTML = '';
        }

        function createBtn(text, onClick, style = 'primary') {
            const btn = document.createElement('button');
            btn.innerHTML = text;
            btn.onclick = (e) => {
                if (gameState.isProcessing) {
                    addLog("è«‹ç­‰å¾…ç•¶å‰æ“ä½œå®Œæˆ...", "system");
                    return;
                }
                onClick(e);
            };
            let classes = "btn-action font-bold py-3 px-6 rounded-lg mb-2 mx-1 shadow-md text-sm tracking-wide ";
            if (style === 'primary') classes += "btn-primary text-white";
            else if (style === 'danger') classes += "btn-danger text-white";
            else if (style === 'gold') classes += "btn-gold text-white";
            else classes += "bg-gradient-to-b from-gray-600 to-gray-700 hover:from-gray-500 hover:to-gray-600 text-gray-100 border-gray-500/50";
            btn.className = classes;
            ui.controls.appendChild(btn);
            return btn; 
        }

        function showSliderInput(label, max, onConfirm, onCancel) {
            clearControls();
            ui.sliderContainer.classList.remove('hidden');
            const slider = document.getElementById('amount-slider');
            const display = document.getElementById('slider-val-display');
            const btnConfirm = document.getElementById('btn-slider-confirm');
            const btnCancel = document.getElementById('btn-slider-cancel');
            const labelEl = document.getElementById('slider-label');

            labelEl.innerText = label;
            slider.max = max;
            slider.value = Math.floor(max / 2); 
            if (max <= 0) slider.value = 0;
            display.innerText = slider.value;

            slider.oninput = () => { display.innerText = slider.value; };
            btnConfirm.onclick = () => { const val = parseInt(slider.value); if (val > 0) onConfirm(val); };
            btnCancel.onclick = onCancel;
        }

        function initGame() {
            gameState.day = 1;
            gameState.gold = 0;
            gameState.bank = 0;
            gameState.stamina = gameState.maxStamina;
            gameState.contractSigned = false;
            gameState.isPurified = false;
            gameState.gameOver = false;
            gameState.inventory = [];
            gameState.location = "start";
            gameState.luckBoost = 0;
            gameState.reputation = { merchant: 0, church: 0, demon: 0 };
            gameState.attributes = { negotiation: 0, insight: 0, luck: 0 };
            gameState.marketModifiers = {};
            gameState.quizHistory = [];
            gameState.role = "æœªå®š";
            gameState.bgStory = "";
            gameState.lastIntelRumor = "";
            gameState.interestRate = 0.05;
            gameState.isProcessing = false;
            stopProcessing();
            
            document.getElementById('contract-badge').classList.add('hidden');
            ui.log.innerHTML = '';
            document.getElementById('event-modal').classList.add('hidden');
            
            ui.log.innerHTML = `<div class="welcome-msg">æ­¡è¿ä¾†åˆ°ã€Šå¥‡çè¡Œå•†ã€‹</div><div class="text-gray-400 text-center italic text-sm">è«‹é¸æ“‡ä½ çš„å‡ºèº«...</div>`;
            
            ui.controls = document.getElementById('controls');
            ui.locName = document.getElementById('location-name');
            ui.locName.innerText = "å‘½é‹çš„åå­—è·¯å£";

            updateUI();
            clearControls();
            
            createBtn("è½å¤©ç”±å‘½", () => startCharCreation('random'), 'gray');
            createBtn("éˆé­‚æ‹·å•", () => startCharCreation('quiz'), 'primary');
            const btnCustom = createBtn("è‡ªæˆ‘å®šç¾©", () => startCharCreation('custom'), 'gold');
            if (!API_KEY) {
                btnCustom.disabled = true;
                btnCustom.className = "btn-action bg-gray-700 text-gray-500 border-gray-600 cursor-not-allowed py-3 px-6 rounded-lg mb-2 mx-1 shadow-inner";
                btnCustom.title = "éœ€è¦ API Key æ‰èƒ½ä½¿ç”¨";
                btnCustom.innerText += " (é™AI)";
            }
        }

        function resetGame() { 
            document.getElementById('event-modal').classList.add('hidden');
            initGame(); 
        }

        function startCharCreation(mode) {
            clearControls();
            if (mode === 'custom') {
                addLog("è«‹è¼¸å…¥ä½ æƒ³è¦æ‰®æ¼”çš„è§’è‰²è¨­å®š...", "system");
                ui.inputContainer.classList.remove('hidden');
                const input = document.getElementById('player-input');
                input.value = ''; // ä¿®æ­£ 1: æ¸…ç©ºè¼¸å…¥æ¡†
                const submit = document.getElementById('submit-input');
                input.placeholder = "è¼¸å…¥è§’è‰²è¨­å®š...";
                submit.onclick = () => {
                    const customRole = input.value.trim();
                    if (!customRole) return;
                    finalizeCharCreation('custom', customRole);
                };
                // åŠ å…¥è¿”å›æŒ‰éˆ•
                createBtn("è¿”å›é¸æ“‡", initGame, 'gray');
                return;
            } else if (mode === 'quiz') {
                startSoulQuestioning();
                return;
            }
            finalizeCharCreation(mode, null);
        }

        async function startSoulQuestioning() {
            clearControls();
            addLog("æ­£åœ¨é€£æ¥éˆé­‚è¿´è·¯...", "system");
            startProcessing(); // å•Ÿç”¨é˜²å‘†
            gameState.quizHistory = []; 
            let questions = [];
            if (API_KEY) {
                const prompt = `è«‹ç”Ÿæˆ3å€‹è§’è‰²æ‰®æ¼”é¸æ“‡é¡Œï¼Œç”¨æ–¼æ±ºå®šå¥‡å¹»å•†äººçš„åˆå§‹èƒ½åŠ›ã€‚é¡Œç›®ä¸»é¡Œåˆ†åˆ¥ç‚ºï¼š1.é“å¾·æŠ‰æ“‡ 2.å•†æ¥­é¢¨éšª 3.ç”Ÿå­˜åæ‡‰ã€‚è«‹å›å‚³ç´” JSON é™£åˆ— (Array of Objects)ï¼Œæ ¼å¼ç‚ºï¼š[{"q":"é¡Œç›®å…§å®¹", "a":"é¸é …Aæè¿°", "b":"é¸é …Bæè¿°"}, ... ]ã€‚ä¸è¦æœ‰ Markdown æ ¼å¼ã€‚`;
                try {
                    const jsonStr = await callGemini(prompt);
                    const cleanStr = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim();
                    questions = JSON.parse(cleanStr);
                } catch(e) { console.error("Quiz gen failed", e); }
            }
            stopProcessing(); // è§£é™¤é˜²å‘†

            if (!questions || questions.length < 3) {
                questions = [
                    { q: "é£¢é¤“çš„å°å­©å·äº†ä½ åƒ…å‰©çš„éºµåŒ…ã€‚", a: "å¥ªå›éºµåŒ…", b: "æ”¾ä»–èµ°" },
                    { q: "å‚³èªªä¸­çš„æµ·æ€ªæµ·åŸŸç››ç”¢ç¨€æœ‰é¦™æ–™ã€‚", a: "ALL IN æŠ•è³‡ (é«˜é¢¨éšª)", b: "ä¿å®ˆè§€æœ› (ä½é¢¨éšª)" },
                    { q: "æ·±å¤œåœ¨æ£®æ—éœ²ç‡Ÿæ™‚è½åˆ°ç‹¼åšã€‚", a: "çˆ¬æ¨¹èº²é¿", b: "é»ç«å¨åš‡" }
                ];
            }

            let qIndex = 0;
            const answers = []; 
            const showNextQuestion = () => {
                if (qIndex >= 3) { finalizeQuizCreation(answers); return; }
                const q = questions[qIndex];
                clearControls();
                addLog(`ã€å•é¡Œ ${qIndex+1}ã€‘ ${q.q}`, "important");
                createBtn(`A. ${q.a}`, () => handleAnswer('A', q.a), 'primary');
                createBtn(`B. ${q.b}`, () => handleAnswer('B', q.b), 'gold');
                // åŠ å…¥è¿”å›æŒ‰éˆ•
                createBtn("è¿”å›é¸æ“‡", initGame, 'gray');
            };
            const handleAnswer = (choice, text) => {
                answers.push(choice);
                gameState.quizHistory.push(`Q${qIndex+1}: <span class="text-yellow-400">â¤ é¸æ“‡: ${text}</span>`);
                clearControls();
                addLog(`ä½ é¸æ“‡: ${text}`, "normal");
                setTimeout(() => { qIndex++; showNextQuestion(); }, 800);
            };
            showNextQuestion();
        }

        async function finalizeQuizCreation(answers) {
            await finalizeCharacter('quiz', answers);
        }

        async function finalizeCharCreation(mode, customInput) {
            await finalizeCharacter(mode, customInput);
        }

        async function finalizeCharacter(mode, input) {
            clearControls();
            ui.inputContainer.classList.add('hidden');
            addLog("å‘½é‹å·²å®šã€‚", "important");
            
            // ä¿®æ­£ 2: è¨­å®šæ›´é«˜çš„èµ·å§‹è³‡é‡‘
            let baseGold = 2000, neg=2, ins=2, luck=2; 
            let roleName = "å‘½é‹ä¹‹å­";
            let story = "";
            let useAiFallback = false; // Add AI Fallback Flag

            // Determine base stats and role name based on input mode (Simulated defaults)
            if (mode === 'quiz') {
                const countA = input.filter(x => x === 'A').length;
                if (countA === 3) { roleName = "ç„¡æƒ…çš„æŠ•æ©Ÿè€…"; baseGold = 2500; neg = 5; luck = 3; }
                else if (countA === 0) { roleName = "è–å¾’å•†äºº"; baseGold = 1500; neg = 2; luck = 2; ins = 4; }
                else { roleName = "ç²¾æ˜çš„å†’éšªå®¶"; baseGold = 2000; neg = 3; ins = 3; luck = 2; }
            } else if (mode === 'random') {
                const roles = ["æµæµªè³­å¾’", "å¤±æ†¶çš„å‚­å…µ", "è¢«é€å‡ºçš„å­¸å¾’", "å°‹å¯¶çµäºº", "è½é­„è©©äºº"];
                roleName = roles[Math.floor(Math.random() * roles.length)];
                // ä¿®æ­£ 2: éš¨æ©Ÿèµ·å§‹è³‡é‡‘ç¯„åœ 1500 G - 2499 G
                baseGold = Math.floor(Math.random() * 1000) + 1500; 
                neg = Math.floor(Math.random() * 5); ins = Math.floor(Math.random() * 5); luck = Math.floor(Math.random() * 5);
            } else { 
                roleName = input;
                baseGold = 2000; neg=3; ins=3; luck=3; // ä¿®æ­£ 2: é è¨­èµ·å§‹è³‡é‡‘
            }
            story = `ä½ æ˜¯${roleName}ï¼Œèº«æ‡·${baseGold}Gï¼Œæº–å‚™åœ¨ç•°ç•Œå¤§å±•èº«æ‰‹ã€‚`; // Default story/stats

            if (API_KEY) {
                addLog("AI æ­£åœ¨æ ¹æ“šä½ çš„é¸æ“‡ç”Ÿæˆåˆ¤è©...", "system");
                startProcessing(); // å•Ÿç”¨é˜²å‘†
                const context = mode==='quiz' ? `é¸æ“‡:${input.join(',')}` : `è¨­å®š:${roleName}`;
                const prompt = `ç©å®¶å‰µè§’è³‡æ–™: ${context}ã€‚ç›®æ¨™: 5å¤©å…§è³º10,000Gã€‚è«‹ç”ŸæˆèƒŒæ™¯æ•…äº‹ã€‚
                å›å‚³JSONæ ¼å¼: {"story": "æ•…äº‹å…§å®¹(ç´„200å­—)", "title": "è·æ¥­ç¨±è™Ÿ", "stats": {"negotiation": 0-5, "insight": 0-5, "luck": 0-5, "gold": 1500000}}`;
                
                try {
                    const jsonStr = await callGemini(prompt, true);
                    if (jsonStr) {
                        try {
                            const res = JSON.parse(jsonStr);
                            story = res.story; 
                            roleName = res.title;
                            if (res.stats) {
                                // AI ç”Ÿæˆçš„ gold ä¹Ÿæ‡‰åœ¨åˆç†ç¯„åœï¼Œæ­¤è™•ä½¿ç”¨ AI çš„æ•¸å€¼
                                baseGold = res.stats.gold; 
                                neg = res.stats.negotiation; 
                                ins = res.stats.insight; 
                                luck = res.stats.luck; 
                            }
                        } catch (e) {
                            console.error("JSON Parsing Error, using fallback:", e);
                            useAiFallback = true;
                        }
                    } else {
                        // callGemini returned null (API error/timeout)
                        useAiFallback = true;
                    }
                } catch(e) { 
                    console.error("API Call Error during Char Finalize:", e);
                    useAiFallback = true;
                }
                stopProcessing(); // è§£é™¤é˜²å‘†
            }
            
            if (useAiFallback) {
                 addLog("AI é€£ç·šå¤±æ•—ï¼Œä½¿ç”¨æ¨¡æ“¬èƒŒæ™¯æ•…äº‹ã€‚", "system");
                 // The default roleName and story defined before the if(API_KEY) block are used here.
            }


            gameState.gold = baseGold;
            gameState.attributes = { negotiation: neg, insight: ins, luck: luck };
            gameState.role = roleName;
            gameState.bgStory = story;
            
            updateUI();
            addLog(`å‰µè§’å®Œæˆï¼`, "important");
            const div = document.createElement('div');
            div.className = "fade-in mb-2 leading-relaxed text-purple-300 italic border-l-4 border-purple-500 pl-4 py-2 bg-purple-900/20 story-content";
            div.innerHTML = marked.parse(story);
            ui.log.prepend(div);
            addLog(`åˆå§‹è³‡é‡‘: ${gameState.gold} G`, "system");

            startGameplay();
        }

        async function startGameplay() {
            await gatherIntel(false); 
            addLog("é€™æ˜¯ä¸€å€‹å……æ»¿æ©Ÿæœƒèˆ‡å±éšªçš„ä¸–ç•Œã€‚ä½ è¦å»å“ªè£¡ï¼Ÿ", "normal");
            enterMainMap(); 
        }

        async function generateDevilGreeting() {
            if (!API_KEY) {
                addLog("æƒ¡é­”ä½èª: ã€ä½ ä»¥ç‚ºé€™æ¨£å°±èƒ½é€ƒè„«å—ï¼Ÿã€", "devil-text");
                return;
            }
            addLog("æƒ¡é­”æ­£åœ¨å‚³é€è¨Šæ¯...", "system");
            startProcessing(); // å•Ÿç”¨é˜²å‘†
            const prompt = `ä½ æ˜¯ä¸€å€‹èˆ‡å¥‡å¹»å•†äººç°½è¨‚å¥‘ç´„çš„æƒ¡é­”ã€‚è«‹ç”¨è¼•è”‘ã€å˜²è«·æˆ–å……æ»¿å¨è„…çš„èªæ°£ï¼Œç‚ºç©å®¶ç”Ÿæˆä¸€å¥ç°¡çŸ­çš„æ¯æ—¥å•å€™(30å­—å…§)ã€‚ç©å®¶çš„è·æ¥­æ˜¯ ${gameState.role}ï¼Œç›®å‰è³‡ç”¢ç¸½è¨ˆ ${(gameState.gold + gameState.bank).toLocaleString()} Gã€‚`;
            try {
                const greeting = await callGemini(prompt);
                if (greeting) {
                    addLog(`æƒ¡é­”ä½èª: ã€${greeting}ã€`, "danger");
                }
            } catch(e) {
                addLog("æƒ¡é­”ä½èª: ã€ä½ ä»¥ç‚ºé€™æ¨£å°±èƒ½é€ƒè„«å—ï¼Ÿã€", "devil-text");
            } finally {
                stopProcessing(); // è§£é™¤é˜²å‘†
            }
        }

        function enterMainMap() {
            gameState.location = "map";
            ui.locName.innerText = "ä¸–ç•Œåœ°åœ–";
            clearControls();
            updateUI();
            //addLog("é€™æ˜¯ä¸€å€‹å……æ»¿æ©Ÿæœƒèˆ‡å±éšªçš„ä¸–ç•Œã€‚ä½ è¦å»å“ªè£¡ï¼Ÿ", "normal");
            createBtn("é»ƒé‡‘å•†æœƒ", () => visitLocation('merchant_guild'), 'gold');
            createBtn("è–å…‰æ•™å ‚", () => visitLocation('church_district'), 'primary');
            createBtn("åœ°ä¸‹é»‘å¸‚", () => visitLocation('black_market'), 'danger');
            
            const cost = gameState.livingCost;
            let btnStyle = 'btn-primary';
            let warningText = '';
            if (gameState.gold < cost) {
                btnStyle = 'btn-danger animate-pulse';
                warningText = ` (âš ï¸ è³‡é‡‘ä¸è¶³)`;
            }
            const endBtn = document.createElement('button');
            endBtn.innerHTML = `<i class="fas fa-moon mr-2"></i>çµæŸé€™ä¸€å¤©${warningText}`;
            endBtn.className = `btn-action py-3 px-6 rounded-lg mt-4 border w-full ${btnStyle} text-white font-bold`;
            endBtn.onclick = endDay;
            ui.controls.appendChild(document.createElement('br'));
            ui.controls.appendChild(endBtn);
        }

        function visitLocation(locKey) {
            if (!LOCATIONS[locKey]) return; 
            if (gameState.location !== locKey) {
                if (gameState.stamina < 1) { addLog("ä½ ç´¯å¾—å‹•å½ˆä¸å¾—ï¼Œå¿…é ˆä¼‘æ¯äº†ã€‚", "danger"); return; }
                gameState.stamina -= 1;
                addDevilComment('move');
            }
            gameState.location = locKey;
            const loc = LOCATIONS[locKey];
            ui.locName.innerText = loc.name;
            
            updateUI(); clearControls();
            addLog(`ä½ ä¾†åˆ°äº†ã€${loc.name}ã€‘ã€‚`, "important");
            addLog(loc.desc, "normal");

            createBtn("å°‹æ‰¾äº¤æ˜“å°è±¡ (-2 é«”åŠ›)", findTradeTarget, 'gold');
            createBtn("æ‰“æ¢æƒ…å ± (-1 é«”åŠ›)", () => gatherIntel(true), 'primary'); 
            if (locKey === 'merchant_guild') createBtn("éŠ€è¡Œæ¥­å‹™ (-1 é«”åŠ›)", bankAction, 'primary');
            if (locKey === 'black_market') createBtn("æ·±æ·µè³­å ´", () => gambleAction(false), 'danger');
            
            // æ·¨åŒ–åŠŸèƒ½
            if (locKey === 'church_district' && gameState.contractSigned) {
                 createBtn("æ·¨åŒ–å¥‘ç´„ (-3 é«”åŠ›)", purifyContract, 'primary');
            }
            
            createBtn("è¿”å›åœ°åœ–", enterMainMap, 'gray');
        }

        function purifyContract() {
            if (gameState.stamina < 3) { addLog("é«”åŠ›ä¸è¶³ (éœ€è¦ 3)ã€‚", "danger"); return; }
            if (gameState.gold < 5000) { addLog("ä½ éœ€è¦è‡³å°‘ 5,000 Gã€‚", "danger"); return; }
            if (gameState.reputation.church < 10) { addLog("æ•™æœƒçš„ä¿¡ä»»ä¸è¶³ (éœ€è¦æ•™æœƒè²æœ› 10)ã€‚", "danger"); return; }

            gameState.stamina -= 3;
            gameState.gold -= 5000;
            
            gameState.contractSigned = false;
            gameState.isPurified = true; // Hidden flag
            gameState.livingCost = 100;
            
            gameState.reputation.church += 10;
            gameState.reputation.demon -= 30; 
            
            // ä¿®æ­£ 1: ç§»é™¤ç»é‡‘å­—çœ¼
            addLog("è–å…‰é™è‡¨ï¼ä½ å·²æ”¯ä»˜ 5,000 Gï¼Œå¥‘ç´„çš„å°è¨˜è¢«**æ·¨åŒ–**äº†ã€‚æ•™æœƒè²æœ› +10ï¼Œé­”ç•Œè²æœ› -30ã€‚", "church-text");
            addLog("ä½ çš„æ¯æ—¥ç”Ÿæ´»è²»æ¢å¾©åˆ° 100 Gã€‚ä½†é™°å½±ä¼¼ä¹ä»åœ¨è •å‹•...", "important");
            
            updateUI(); clearControls(); visitLocation('church_district');
        }

        async function generateDynamicItem(npc) {
            const types = ['negotiation', 'insight', 'luck', 'intel'];
            const type = types[Math.floor(Math.random() * types.length)];
            let item = { name: "æœªçŸ¥ç‰©å“", type: type, boost: parseFloat((Math.random() * 1.5 + 0.5).toFixed(1)), basePrice: 0, trueValue: 0, desc: "ç¥ç§˜ç‰©å“" };
            if (type === 'intel') { item.boost = 0; item.basePrice = 150; item.trueValue = 200; }

            if (API_KEY) {
                const prompt = `NPC: ${npc.name} (${npc.faction})ã€‚ç©å®¶èƒŒæ™¯: ${gameState.role}ã€‚ç”Ÿæˆä¸€å€‹${type}é¡å‹ç‰©å“ã€‚
                åŒæ™‚ç”Ÿæˆå…©å€‹ç°¡çŸ­çš„äº¤æ˜“æˆåŠŸèˆ‡å–æ¶ˆçš„å°è©(èˆ‡NPCå€‹æ€§åŠç‰©å“ç›¸é—œ)ã€‚
                JSON: {"name": "åç¨±", "desc": "æè¿°", "basePrice": æ•¸å­—(100-1000), "success_msg": "äº¤æ˜“æˆåŠŸå°è©", "cancel_msg": "äº¤æ˜“å–æ¶ˆå°è©"}`;
                try {
                    const jsonStr = await callGemini(prompt, true);
                    if(jsonStr) {
                        const aiItem = JSON.parse(jsonStr);
                        item.name = aiItem.name; item.desc = aiItem.desc;
                        item.success_msg = aiItem.success_msg;
                        item.cancel_msg = aiItem.cancel_msg;
                        if(type !== 'intel') { item.basePrice = aiItem.basePrice; item.trueValue = Math.floor(aiItem.basePrice * (Math.random() * 0.4 + 0.8)); }
                        else { item.basePrice = Math.max(50, aiItem.basePrice); item.trueValue = item.basePrice + 50; }
                    }
                } catch(e) {}
            } 
            
            if (item.name === "æœªçŸ¥ç‰©å“") {
                const mock = ITEM_TEMPLATES.find(i => i.type === type) || ITEM_TEMPLATES[0];
                item.name = mock.name; item.desc = mock.desc;
                item.success_msg = "åˆä½œæ„‰å¿«ã€‚"; item.cancel_msg = "å“¼ï¼Œæµªè²»æ™‚é–“ã€‚";
                if(type !== 'intel') { item.basePrice = mock.basePrice; item.trueValue = mock.trueValue; }
                else { item.basePrice = 150; item.trueValue = 200; }
            }
            return item;
        }

        async function findTradeTarget() {
            if (gameState.stamina < 2) { addLog("é«”åŠ›ä¸è¶³ (éœ€è¦ 2)ã€‚", "danger"); return; }
            gameState.stamina -= 2;

            const locFaction = LOCATIONS[gameState.location].faction;
            let availableNpcs = NPCS.filter(n => n.faction === locFaction);
            if (availableNpcs.length === 0) availableNpcs = NPCS;
            
            let npc = { ...availableNpcs[Math.floor(Math.random() * availableNpcs.length)] };

            if (API_KEY) {
                const locName = LOCATIONS[gameState.location].name;
                const context = gameState.bgStory ? `ç©å®¶èƒŒæ™¯: "${gameState.bgStory.substring(0, 100)}..."` : "éš¨æ©Ÿè·¯äºº";
                const prompt = `${context}ã€‚åœ¨${locName}ç”ŸæˆNPCã€‚JSON: {"name": "åå­—", "desc": "æè¿°"}`;
                addLog("æ­£åœ¨å°‹æ‰¾äº¤æ˜“å°è±¡...", "system");
                startProcessing(); // å•Ÿç”¨é˜²å‘†
                try {
                    const jsonStr = await callGemini(prompt, true);
                    if(jsonStr) { const aiNpc = JSON.parse(jsonStr); if (aiNpc.name) { npc.name = aiNpc.name; npc.desc = aiNpc.desc; } }
                } catch(e) {}
                stopProcessing(); // è§£é™¤é˜²å‘†
            }

            const item = await generateDynamicItem(npc);
            
            let negotiationOptions = null;
            if (API_KEY) {
                const prompt2 = `é‡å°ç‰©å“ã€Œ${item.name}ã€(${item.desc})ï¼Œç”Ÿæˆ2å€‹ç°¡çŸ­æ®ºåƒ¹è—‰å£(20å­—å…§)ã€‚JSONé™£åˆ—: ["ç†ç”±1", "ç†ç”±2"]`;
                startProcessing(); // å•Ÿç”¨é˜²å‘†
                try { 
                    const jsonStr2 = await callGemini(prompt2, true); 
                    // ä¿®æ­£: ç¢ºä¿å³ä½¿ API å¤±æ•— (è¿”å› null) ä¹Ÿèƒ½å®‰å…¨è§£æ
                    if(jsonStr2) negotiationOptions = JSON.parse(jsonStr2); 
                } catch(e) {
                    // å¦‚æœè§£ææˆ–èª¿ç”¨å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼
                    negotiationOptions = null; 
                }
                stopProcessing(); // è§£é™¤é˜²å‘†
            }
            // ä½¿ç”¨é è¨­å€¼ä½œç‚ºæœ€çµ‚å›é€€
            npc.negotiationOptions = negotiationOptions || NEGOTIATION_PRESETS;

            const rep = gameState.reputation[npc.faction] || 0;
            let priceMod = 1.0 - (rep * 0.01); if (priceMod < 0.5) priceMod = 0.5;
            const currentLoc = gameState.location;
            
            const typeModData = gameState.marketModifiers[item.type];
            if (typeModData && (!typeModData.location || typeModData.location === currentLoc)) priceMod *= typeModData.val;

            const totalLuck = gameState.attributes.luck + gameState.luckBoost;
            if (totalLuck > 5) priceMod -= 0.05;

            item.basePrice = Math.floor(item.basePrice * (0.8 + Math.random() * 0.4) * priceMod);
            gameState.npcCurrent = { npc, item };
            
            clearControls(); updateUI();
            addLog(`ä½ é‡åˆ° **${npc.name}**ã€‚`, "npc");
            addLog(`${npc.desc}`, "normal");
            if (rep > 10) addLog(`(é—œä¿‚è‰¯å¥½) NPC å°ä½ é»é ­è‡´æ„ã€‚`, "system");

            let btnText = `æŸ¥çœ‹è²¨å“ (${TYPE_TRANSLATIONS[item.type]})`;
            createBtn(btnText, () => showBuyMenu(npc, item), 'gold');
            createBtn("å…œå”®æˆ‘çš„ç‰©å“", () => showSellMenu(npc), 'primary');
            createBtn("é›¢é–‹", () => visitLocation(gameState.location), 'gray');
        }

        function showBuyMenu(npc, item) {
            clearControls();
            let typeText = TYPE_TRANSLATIONS[item.type];
            let boostText = item.type==='intel' ? 'ç²å¾—æ–°æƒ…å ±' : `${typeText} +${item.boost}`;
            
            addLog(`${npc.name}: ã€Œé€™å¯æ˜¯ **${item.name}** (${typeText})ã€‚${item.desc}ã€`, "npc");
            addLog(`æ•ˆæœé ä¼°: ${boostText}`, "important");
            addLog(`åƒ¹æ ¼: ${item.basePrice} G`, "system");
            const totalInsight = gameState.attributes.insight; 
            if (totalInsight >= 2) addLog(`(æ´å¯Ÿ) å¸‚å ´ä¼°å€¼ç´„: ${item.trueValue} G`, "system");

            createBtn(`è³¼è²· (-${item.basePrice} G)`, () => buyItemAttempt(item.basePrice), 'gold');
            createBtn("å˜—è©¦æ®ºåƒ¹ (è«‡åˆ¤)", () => startNegotiation('buy'), 'primary');
            createBtn("ä¸è²·äº†", () => {
                addLog(`${npc.name}: ã€Œ${item.cancel_msg || "å“¼ï¼Œæµªè²»æ™‚é–“ã€‚"}ã€`, "npc");
                visitLocation(gameState.location);
            }, 'gray');
        }

        function showSellMenu(npc) {
            clearControls();
            const sellableItems = gameState.inventory.filter(i => i.type !== 'intel');
            if (sellableItems.length === 0) { addLog(`${npc.name}: ã€Œä½ å…©æ‰‹ç©ºç©ºï¼Œæ˜¯ä¾†æ¶ˆé£æˆ‘çš„å—ï¼Ÿã€`, "npc"); createBtn("æŠ±æ­‰ (é›¢é–‹)", () => visitLocation(gameState.location), 'gray'); return; }
            addLog(`${npc.name}: ã€Œä½ æƒ³è³£ä»€éº¼ï¼Ÿã€`, "npc");
            sellableItems.forEach((invItem) => {
                const rep = gameState.reputation[npc.faction] || 0;
                let marketFactor = 1.0;
                const typeModData = gameState.marketModifiers[invItem.type];
                if (typeModData && (!typeModData.location || typeModData.location === gameState.location)) marketFactor = typeModData.val;
                
                let offerMod = (0.6 + (gameState.attributes.negotiation * 0.05) + (rep * 0.01)) * marketFactor;
                const offerPrice = Math.floor(invItem.trueValue * offerMod);
                createBtn(`${invItem.name} (å ±åƒ¹: ${offerPrice} G)`, () => sellItemAttempt(invItem, offerPrice), 'gold');
            });
            createBtn("ç®—äº†", () => visitLocation(gameState.location), 'gray');
        }

        function buyItemAttempt(price) {
            if (gameState.gold >= price) executeBuy(price);
            else { 
                // ä¿®æ­£ 2: è³¼è²·å¥‘ç´„è§¸ç™¼é‚è¼¯ - è‹¥ > 3å€è³‡é‡‘ï¼Œä¸è§¸ç™¼å¥‘ç´„
                if (price >= 3 * Math.max(1, gameState.gold)) {
                    addLog("æƒ¡é­”å˜²ç¬‘ä½ ï¼šã€æƒ³è²·é€™å€‹ï¼Ÿä½ çš„éˆé­‚é‚„ä¸å€¼é‚£éº¼å¤šéŒ¢ã€‚æ»¾å§ï¼ã€", "devil-text");
                    return; 
                }
                gameState.pendingPurchase = price; 
                triggerDevilEvent('shopping', price); 
            }
        }

        async function executeBuy(price) {
            gameState.gold -= price;
            const item = gameState.npcCurrent.item;
            const faction = gameState.npcCurrent.npc.faction;
            const npc = gameState.npcCurrent.npc;
            gameState.reputation[faction] += 1;
            
            addLog(`${npc.name}: ã€Œ${item.success_msg || "åˆä½œæ„‰å¿«ã€‚"}ã€ (${FACTION_NAMES[faction]}è²æœ› +1)`, "npc");
            addDevilComment('trade');

            if (item.type === 'intel') {
                addLog(`ä½ è³¼è²·äº†æƒ…å ±ï¼`, "important");
            } else {
                gameState.inventory.push(item);
                addLog(`æˆäº¤ï¼ç²å¾— [${item.name}]ã€‚${TYPE_TRANSLATIONS[item.type] || item.type} +${item.boost}`, "important");
            }
            updateUI(); visitLocation(gameState.location);
        }

        function sellItemRef(itemRef, price) {
            const index = gameState.inventory.indexOf(itemRef);
            if (index > -1) {
                const faction = gameState.npcCurrent.npc.faction;
                gameState.reputation[faction] += 1;
                
                if (gameState.contractSigned) {
                    const bonus = Math.floor(price * 0.5); 
                    price += bonus;
                    addLog(`æƒ¡é­”ä½èª: ã€æˆ‘å¹«ä½ æŠ¬äº†åƒ¹...å¤šè³ºäº† ${bonus} Gã€‚ã€`, "danger");
                }
                
                gameState.gold += price;
                gameState.inventory.splice(index, 1);
                addLog(`ä½ ä»¥ ${price} G è³£å‡ºäº† [${itemRef.name}]ã€‚ (${FACTION_NAMES[faction]}è²æœ› +1)`, "important");
                addDevilComment('trade');
                updateUI(); visitLocation(gameState.location);
            }
        }

        function sellItemAttempt(itemRef, price) {
            sellItemRef(itemRef, price);
        }

        function startNegotiation(type) {
            clearControls();
            addLog("è«‹é¸æ“‡æˆ–è¼¸å…¥ä½ çš„è©±è¡“:", "system");
            ui.inputContainer.classList.remove('hidden');
            // ä¿®æ­£ 1: æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('player-input').value = ''; 
            document.getElementById('player-input').placeholder = "è¼¸å…¥ä½ çš„å›æ‡‰..."; 

            let presets = gameState.npcCurrent.npc.negotiationOptions || NEGOTIATION_PRESETS;
            ui.presetOptions.innerHTML = '';
            presets.slice(0, 2).forEach(text => {
                const btn = document.createElement('button');
                btn.className = "text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 py-2 px-3 rounded border border-gray-600 text-left truncate max-w-[200px] flex-shrink-0";
                btn.innerText = text;
                btn.onclick = () => processNegotiation(text, type);
                ui.presetOptions.appendChild(btn);
            });
            document.getElementById('submit-input').onclick = () => {
                const text = document.getElementById('player-input').value;
                if (!text) return;
                processNegotiation(text, type);
            };
        }

        async function processNegotiation(text, type) {
            ui.inputContainer.classList.add('hidden');
            ui.presetOptions.innerHTML = '';
            addLog(`ä½ : ã€Œ${text}ã€`, "player");
            addLog("è«‡åˆ¤åˆ¤å®šä¸­...", "system");
            startProcessing(); // å•Ÿç”¨é˜²å‘†

            let dc = 12; let npcResponse = "é€™...";
            if (API_KEY) {
                const npc = gameState.npcCurrent.npc;
                const item = gameState.npcCurrent.item;
                const prompt = `NPC: ${npc.name} (${npc.personality}) æ­£åœ¨è³£ ${item.name} (${item.basePrice}G)ã€‚ç©å®¶èªª: "${text}"ã€‚è«‹ä»¥JSONæ ¼å¼å›å‚³: {"dc": number (1-20), "response": "NPCçš„ç°¡çŸ­å›æ‡‰"}`;
                try { const jsonStr = await callGemini(prompt, true); const result = JSON.parse(jsonStr); dc = result.dc; npcResponse = result.response; } catch(e) {}
            }
            if (gameState.contractSigned) { dc += 5; addLog("(å¥‘ç´„è©›å’’) ä½ çš„éˆé­‚æ•£ç™¼è‘—ä¸è©³æ°£æ¯ï¼Œå°æ–¹æˆ’å¿ƒæé«˜äº†ã€‚", "danger"); }

            addLog(`${gameState.npcCurrent.npc.name}: ã€Œ${npcResponse}ã€`, "npc");
            addLog(`(ç³»çµ±) è«‡åˆ¤é›£åº¦ DC: ${dc}`, "system");

            setTimeout(() => {
                const roll = Math.floor(Math.random() * 20) + 1;
                const totalLuck = gameState.attributes.luck + gameState.luckBoost;
                const total = roll + gameState.attributes.negotiation + Math.floor(totalLuck / 2);
                addLog(`ğŸ² æ“²éª°: ${roll} + æŠ€èƒ½(${gameState.attributes.negotiation}) + é‹æ°£ä¿®æ­£(${Math.floor(totalLuck/2)}) = ${total}`, "important");
                clearControls();
                stopProcessing(); // è§£é™¤é˜²å‘†

                if (total >= dc) {
                    const discount = Math.floor(gameState.npcCurrent.item.basePrice * 0.7);
                    addLog(`è«‡åˆ¤æˆåŠŸï¼åƒ¹æ ¼é™ä½è‡³ ${discount} Gã€‚`, "important");
                    createBtn(`æˆäº¤ (ä»˜ ${discount} G)`, () => buyItemAttempt(discount), 'gold');
                    createBtn(`å–æ¶ˆäº¤æ˜“`, () => { 
                        addLog(`${gameState.npcCurrent.npc.name}: ã€Œ${gameState.npcCurrent.item.cancel_msg || "æµªè²»æˆ‘çš„å£æ°´ã€‚"}ã€ (${FACTION_NAMES[gameState.npcCurrent.npc.faction]}è²æœ› -1)`, "npc");
                        gameState.reputation[gameState.npcCurrent.npc.faction] -= 1;
                        visitLocation(gameState.location); 
                    }, 'gray');
                } else {
                    addLog(`è«‡åˆ¤å¤±æ•—ï¼å°æ–¹æ‹’çµ•é™åƒ¹ã€‚ (${FACTION_NAMES[gameState.npcCurrent.npc.faction]}è²æœ› -1)`, "danger");
                    gameState.reputation[gameState.npcCurrent.npc.faction] -= 1;
                    setTimeout(() => visitLocation(gameState.location), 1500);
                }
            }, 1000);
        }

        async function gatherIntel(manual = true) {
            if (manual) {
                if (gameState.stamina < 1) { addLog("é«”åŠ›ä¸è¶³ (éœ€è¦ 1)ã€‚", "danger"); return; } 
                const btn = document.querySelector('button[onclick*="gatherIntel"]');
                if(btn) { btn.innerText = "æ‰“æ¢ä¸­..."; btn.disabled = true; }
                if (Math.random() < 0.2) {
                     const currentFaction = LOCATIONS[gameState.location].faction;
                     gameState.reputation[currentFaction] -= 2;
                     addLog(`âš ï¸ ä½ æ‰“æ¢æƒ…å ±çš„è¡Œç‚ºå¼•èµ·äº†æ‡·ç–‘ï¼ (${FACTION_NAMES[currentFaction]}è²æœ› -2)`, "danger");
                }
                addLog(`æ­£åœ¨æ‰“æ¢æ¶ˆæ¯...`, "system");
                startProcessing(); // å•Ÿç”¨é˜²å‘†
                await new Promise(r => setTimeout(r, 1000)); 
                gameState.stamina -= 1; 
            } else {
                addLog("æ­£åœ¨æ”¶é›†ä»Šæ—¥æƒ…å ±...", "system");
                startProcessing(); // å•Ÿç”¨é˜²å‘†
                gameState.inventory = gameState.inventory.filter((item, index) => {
                    if (item.type === 'intel' && Math.random() < 0.3) {
                         addLog(`ã€éæœŸæƒ…å ±ã€‘: ${item.summary} å·²å¤±æ•ˆ`, "system");
                         return false; 
                    }
                    return true;
                });
            }
            
            try {
                const types = ['negotiation', 'insight', 'luck', 'intel'];
                const targetType = types[Math.floor(Math.random() * types.length)]; 
                const effectType = Math.random() > 0.5 ? 'high' : 'low';
                const multiplier = effectType === 'high' ? 1.5 : 0.5;
                
                let targetLoc = null; let targetLocName = "å…¨å¸‚å ´";
                if (Math.random() > 0.5) {
                    const keys = Object.keys(LOCATIONS);
                    targetLoc = keys[Math.floor(Math.random() * keys.length)];
                    targetLocName = LOCATIONS[targetLoc].name;
                }
                
                let rumorText = "";

                if (API_KEY) {
                    const locContext = targetLoc ? `åœ°é»:${targetLocName}` : "åœ°é»:å…¨å¸‚å ´";
                    // ä¿®æ­£ 2: ä¿®æ”¹ Promptï¼Œçµåˆç©å®¶èƒŒæ™¯
                    const prompt = `ç©å®¶è·æ¥­: ${gameState.role}, ç©å®¶èƒŒæ™¯: ${gameState.bgStory.substring(0, 100)}...ã€‚ç”Ÿæˆä¸€æ¢å¥‡å¹»RPGå¸‚å ´æƒ…å ±ã€‚ä¸»é¡Œï¼š${TYPE_TRANSLATIONS[targetType]}é¡ç‰©å“åƒ¹æ ¼${effectType === 'high' ? 'æš´æ¼²' : 'æš´è·Œ'}ã€‚${locContext}ã€‚åŸå› èˆ‡ç©å®¶èƒŒæ™¯æ‡‰æœ‰å¾®å¼±è¯ç¹«ã€‚è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼Œä¸è¦åŒ…å«å­—æ•¸çµ±è¨ˆï¼Œä¸è¦æœ‰å¼•è™Ÿï¼Œ30å­—ä»¥å…§ã€‚`;
                    try {
                       const aiRumor = await callGemini(prompt);
                       if (aiRumor) rumorText = aiRumor; else rumorText = "å¸‚å ´é¢¨é›²è®Šå¹»...";
                    } catch(e) { rumorText = "å¸‚å ´é¢¨é›²è®Šå¹»..."; }
                } else {
                    const typeName = TYPE_TRANSLATIONS[targetType];
                    rumorText = effectType === 'high' ? `è½èªª${targetLocName}çš„${typeName}é¡ç‰©å“ç¾åœ¨éå¸¸æ¶æ‰‹ï¼Œåƒ¹æ ¼æ­£åœ¨ä¸Šæ¼²ã€‚` : `æœ€è¿‘${locContext}çš„${typeName}é¡ç‰©å“ä¾›éæ–¼æ±‚ï¼Œåƒ¹æ ¼ä¸‹è·Œäº†ã€‚`;
                }
                
                gameState.lastIntelRumor = rumorText; 
                
                const logType = manual ? "important" : "system";
                const prefix = manual ? "ç²å¾—æƒ…å ±: " : "ã€æ¯æ—¥æƒ…å ±ã€‘: ";
                
                const typeName = TYPE_TRANSLATIONS[targetType] || targetType;
                const trendText = effectType === 'high' ? 'åƒ¹æ ¼ä¸Šæ¼²' : 'åƒ¹æ ¼ä¸‹è·Œ';
                let summary = `${typeName}é¡ ${trendText}`;
                if (targetLoc) {
                    summary = `${summary} [${targetLocName}]`;
                }

                addLog(`${prefix}${rumorText.replace(/ã€.*?ã€‘: /g, '')} (${typeName} x${multiplier})`, logType);
                
                gameState.inventory.push({
                    name: "æƒ…å ± #" + (Math.floor(Math.random()*1000)),
                    summary: summary, 
                    desc: rumorText + ` (å½±éŸ¿: ${targetLocName} ${typeName} åƒ¹æ ¼ x${multiplier})`, 
                    basePrice: 50 + Math.floor(Math.random()*150),
                    trueValue: 50 + Math.floor(Math.random()*150),
                    type: 'intel'
                });
                
                if (!manual) {
                    gameState.marketModifiers = {}; 
                    gameState.marketModifiers[targetType] = { val: multiplier, location: targetLoc };
                }

                updateUI();
                if (manual) { 
                    switchTab('intel'); 
                    visitLocation(gameState.location); 
                }
            } finally {
                stopProcessing(); // è§£é™¤é˜²å‘†
                if (!manual) {
                    updateUI();
                    enterMainMap();
                }
            }
        }

        function bankAction() {
            if (gameState.stamina < 1) { addLog("é«”åŠ›ä¸è¶³ (éœ€è¦ 1)ã€‚", "danger"); return; }
            clearControls(); gameState.stamina -= 1; updateUI();
            const currentRate = (gameState.interestRate * 100).toFixed(1);
            addLog(`éŠ€è¡Œæ«ƒæª¯: ã€Œä»Šæ—¥åˆ©ç‡ç‚º ${currentRate}%ã€‚å­˜æ¬¾æ‰‹çºŒè²» 10 Gã€‚ã€`, "npc");
            const showBankMenu = () => {
                clearControls();
                createBtn("å­˜å…¥ (æ‰‹çºŒè²» 10 G)", () => {
                    if (gameState.gold <= 10) { addLog("ç¾é‡‘ä¸è¶³ä»¥æ”¯ä»˜æ‰‹çºŒè²»ã€‚", "danger"); showBankMenu(); return; }
                    showSliderInput("å­˜å…¥é‡‘é¡", gameState.gold - 10, (val) => { gameState.gold -= (val + 10); gameState.bank += val; addLog(`å­˜å…¥ ${val} Gã€‚`, "important"); updateUI(); showBankMenu(); }, showBankMenu);
                }, 'primary');
                createBtn("å–å‡º (å…æ‰‹çºŒè²»)", () => {
                    if (gameState.bank <= 0) { addLog("ä½ æ²’æœ‰å­˜æ¬¾ã€‚", "danger"); showBankMenu(); return; }
                    showSliderInput("å–å‡ºé‡‘é¡", gameState.bank, (val) => { gameState.bank -= val; gameState.gold += val; addLog(`å–å‡º ${val} Gã€‚`, "important"); updateUI(); showBankMenu(); }, showBankMenu);
                }, 'primary');
                createBtn("é›¢é–‹", () => visitLocation('merchant_guild'), 'gray');
            };
            showBankMenu();
        }

        function gambleAction(quiet = false) {
            clearControls();
            if (!quiet) addLog("è·å®˜: ã€Œæ­¡è¿ä¾†åˆ°æ·±æ·µè³­å ´ã€‚æ•¢ä¾†è©¦è©¦æ‰‹æ°£å—ï¼Ÿã€", "npc");
            ui.inputContainer.classList.remove('hidden');
            const input = document.getElementById('player-input');
            const submit = document.getElementById('submit-input');
            input.value = ''; input.placeholder = `è¼¸å…¥è³­æ³¨ (ç¾æœ‰: ${gameState.gold} G)...`;
            submit.onclick = () => {
                const bet = parseInt(input.value);
                if (isNaN(bet) || bet <= 0) { addLog("è·å®˜: ã€è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡ï¼æ²’éŒ¢å°±åˆ¥ä¸‹æ³¨ã€‚ã€", "npc"); return; }
                
                if (bet > gameState.gold) {
                     if (gameState.contractSigned) {
                         addLog("è·å®˜: ã€å“ˆå“ˆï¼Œå¥‘ç´„çš„å¥´éš¸ï¼æƒ³è·Ÿæˆ‘ç©ç©ºæ‰‹å¥—ç™½ç‹¼ï¼Ÿã€", "npc");
                         return;
                     }
                     // ä¿®æ­£ 2: è³­å ´å¥‘ç´„é‚è¼¯
                     const currentGold = Math.max(0, gameState.gold);
                     let context = 'gambling_mid';
                     let modalBet = bet; 

                     if (bet >= 3 * currentGold) {
                         context = 'gambling_high';
                         modalBet = 3 * currentGold;
                     } else if (bet < 666) {
                         context = 'gambling_low';
                         modalBet = bet;
                     } else {
                         context = 'gambling_mid';
                         modalBet = bet; 
                     }
                     
                     gameState.pendingBetAmount = modalBet; 
                     gameState.forcedGamble = true; 
                     triggerDevilEvent(context, modalBet); 
                     return;
                 }
                executeGamble(bet, false);
            };
            createBtn("é›¢é–‹", () => { ui.inputContainer.classList.add('hidden'); visitLocation('black_market'); }, 'gray');
        }

        function executeGamble(bet, isProtected) {
            if (gameState.stamina < 1) { addLog("é«”åŠ›ä¸è¶³ (éœ€è¦ 1)ã€‚", "danger"); ui.inputContainer.classList.add('hidden'); visitLocation('black_market'); return; }
            gameState.stamina -= 1; 
            
            // If NOT protected (regular gamble), pay upfront.
            if (!isProtected) gameState.gold -= bet; 
            
            updateUI(); ui.inputContainer.classList.add('hidden'); clearControls();
            
            const totalLuck = gameState.attributes.luck + gameState.luckBoost;
            const playerBase = Math.floor(Math.random() * 12) + 1;
            const playerRoll = playerBase + Math.floor(totalLuck / 2); 
            const houseRoll = Math.floor(Math.random() * 0) + 1;
            
            addLog(`ä½ æ“²å‡ºäº† [${playerBase}] ${totalLuck>0 ? `+ é‹æ°£(${Math.floor(totalLuck/3)})` : ''} = ${playerRoll} é»`, "important");
            setTimeout(() => {
                const finalHouseRoll = houseRoll + 3;
                addLog(`è·å®˜æ“²å‡ºäº† ${finalHouseRoll} é»...`, "npc");
                let win = playerRoll > finalHouseRoll; // House cheats
                
                if (playerRoll === finalHouseRoll) { 
                    // ä¿®æ­£: ç„¡è«–æ˜¯å¦å—ä¿è­·ï¼Œå¹³å±€éƒ½é€€é‚„è³­æ³¨
                    gameState.gold += bet; 
                    addLog("å¹³æ‰‹ã€‚é€€é‚„è³­æ³¨ã€‚", "normal"); 
                }
                else if (win) {
                    // Win Logic
                    // Regular contract signed (not trigger moment) is x4
                    const multiplier = gameState.contractSigned ? 4 : 2;
                    const winAmount = bet * multiplier;
                    gameState.gold += winAmount;
                    if (gameState.contractSigned) addLog(`æƒ¡é­”ä¹‹åŠ›ï¼ä½ è´äº† ${winAmount} G (4å€)ï¼`, "danger");
                    else addLog(`ä½ è´äº†ï¼ç²å¾— ${winAmount} Gã€‚`, "important");
                } else {
                    // Lose Logic
                    addLog("ä½ è¼¸äº†...", "danger");
                    
                    if (isProtected) {
                        // ç°½ç´„ç•¶ä¸‹çš„è³­å±€è¼¸äº† -> è®Šç‚º 6 G
                        gameState.gold = 6;
                        addLog("æƒ¡é­”å˜²ç¬‘è‘—ï¼šã€çœŸéºæ†¾...ä½ çš„è³‡ç”¢è®Šæˆäº† 6 Gã€‚é€™å°±æ˜¯ä»£åƒ¹ã€‚ã€", "danger");
                    } else if (gameState.contractSigned) {
                        // ç°½ç´„å¾Œçš„æ™®é€šè³­å±€è¼¸äº† -> è¼¸ 4 å€ (å·²ä»˜ 1x bet, å†æ‰£ 3x bet)
                        const penalty = bet * 3;
                        gameState.gold -= penalty;
                        addLog(`æƒ¡é­”ç´¢å–äº†é¡å¤–ä»£åƒ¹... (é¡å¤–æ‰£é™¤ ${penalty} Gï¼Œç¸½è¨ˆè¼¸ 4 å€)`, "danger");
                    }
                }
                updateUI(); gambleAction(true); 
                addDevilComment('gamble');
            }, 1000);
        }

        async function endDay() {
            startProcessing();
            gameState.stamina = gameState.maxStamina; 
            const totalWealth = gameState.gold + gameState.bank;
            if (totalWealth >= gameState.goal) { triggerVictory(); return; }
            gameState.interestRate = 0.02 + Math.random() * 0.06;


            // ä¿®æ­£ 1: éŠ€è¡Œå­˜æ¬¾è¨ˆç®— (ç¢ºä¿åœ¨æ”¯ä»˜ç”Ÿæ´»è²»å‰è¨ˆç®—)
            if (gameState.bank > 0) {
                const interest = Math.floor(gameState.bank * gameState.interestRate);
                gameState.bank += interest;
                addLog(`éŠ€è¡Œåˆ©æ¯å…¥å¸³: ${interest} G`, "important");
            }

            //await gatherIntel(false);

            const cost = gameState.livingCost;
            gameState.day += 1;
            // ä¿®æ­£ 2: æ”¯ä»˜ç”Ÿæ´»è²»å‰çš„è² è³‡ç”¢è™•ç†
            let finalGoldAfterCost = gameState.gold - cost;

            if (finalGoldAfterCost >= 0) {
                gameState.gold -= cost;
                addLog(`æ”¯ä»˜ç”Ÿæ´»è²»: -${cost} G`, "system");
                addLog("ä½ å¹³å®‰åº¦éäº†ä¸€æ™šã€‚", "normal");
                updateUI(); // é¡¯å¼æ›´æ–° UI ç¢ºä¿ç”Ÿæ´»è²»æ‰£é™¤é¡¯ç¤º
                // gatherIntel(false);
                gameState.stamina = gameState.maxStamina; 
                addLog(`--- ç¬¬ ${gameState.day} å¤© ---`, "system");
                //gameState.interestRate = 0.02 + Math.random() * 0.06;
                addLog(`ä»Šæ—¥éŠ€è¡Œåˆ©ç‡: ${(gameState.interestRate*100).toFixed(1)}%`, "system");
                //await gatherIntel(false);
                updateUI(); // é¡¯å¼æ›´æ–° UI ç¢ºä¿åˆ©æ¯é¡¯ç¤º
                if (gameState.day > gameState.maxDays) {
                    stopProcessing(); // è§£é™¤é˜²å‘†

                    ui.log.innerHTML = ''; // Clear log
                    clearControls();
                    const endingMessage = `
                        <h1 class="text-4xl font-bold text-gray-500">æœŸé™å·²åˆ°</h1>
                        <p class="text-gray-300">ä½ æœªèƒ½æ¹Šé½Šè´–é‡‘ï¼Œå®¶æ—çš„æ¦®è€€æ°¸é æ¶ˆé€äº†ã€‚</p>
                    `;
                    addLog(endingMessage, 'story');
                    createBtn("é‡æ–°é–‹å§‹", resetGame, 'primary');
                    gameState.gameOver = true;
                } 
            } else {
                // Not enough money -> Contract Trigger
                
                if (gameState.contractSigned) {
                    stopProcessing(); // è§£é™¤é˜²å‘†

                    ui.log.innerHTML = ''; 
                    clearControls();
                    const endingMessage = `
                        <h1 class="text-4xl font-bold text-red-600">éˆé­‚æ”¶å‰²</h1>
                        <p class="text-gray-300">ä½ ç„¡æ³•æ”¯ä»˜ç”Ÿæ´»è²»ï¼Œæƒ¡é­”ä¾ç´„æ”¶èµ°äº†ä½ çš„éˆé­‚ã€‚</p>
                    `;
                    addLog(endingMessage, 'danger');
                    createBtn("å¢®å…¥åœ°ç„ (é‡å•Ÿ)", resetGame, 'danger');
                    gameState.gameOver = true;
                } else {
                    // ä¿®æ­£ 2: è¨­ç½®ç¾é‡‘ç‚º 0ï¼Œé¿å…è² å€¼å‚³éåˆ°æ¨¡æ…‹æ¡†
                    gameState.gold = 0; 
                    updateUI();
                    stopProcessing(); // åœ¨å½ˆå‡ºæ¨¡æ…‹æ¡†å‰è§£é™¤é˜²å‘†
                    triggerDevilEvent('survival', 0); 
                }
            }
            //startProcessing();
            //gameState.day += 1;
            if (gameState.contractSigned) {
                await generateDevilGreeting();
            }
            //await gatherIntel(false);
            stopProcessing();

            if (!gameState.gameOver) {
                await gatherIntel(false);
                stopProcessing(); // ç¢ºä¿åœ¨é€²å…¥ä¸‹ä¸€å¤©åœ°åœ–æ™‚è§£é™¤é˜²å‘†
            }
        }

        function triggerDevilEvent(context, value) {
            const modal = document.getElementById('event-modal');
            const content = document.getElementById('modal-content');
            const actions = document.getElementById('modal-actions');
            modal.classList.remove('hidden');
            document.getElementById('modal-title').innerText = "æƒ¡é­”çš„ä½èª";
            
            let flavorText = "", confirmAction = "";
            let terms = "";
            let commonTerms = `<li>æ¯æ—¥ç”Ÿæ´»è²» <span class="text-red-400">ç¿»å€ (200 G)</span></li><li>è«‡åˆ¤é›£åº¦ <span class="text-red-400">å¤§å¹…æå‡ (+5 DC)</span></li>`;


            if (context === 'shopping') {
                flavorText = `<p class="devil-text font-bold mt-4">ã€å‘µå‘µå‘µ...æ…¾æœ›æ˜¯å€‹å¥½æ±è¥¿ã€‚ã€</p><p>æƒ¡é­”å¯ä»¥å¹«ä½ è²·å–®ã€‚</p>`;
                terms = `<li>æƒ¡é­”ä»£ä»˜è³¼è²·è²»ç”¨</li><li>ç¾æœ‰è³‡é‡‘è¨­å®šç‚º <strong>666 G</strong></li>`;
                confirmAction = `signContract('shopping', ${value})`; 
            } 
            else if (context === 'survival') {
                flavorText = `<p class="devil-text font-bold mt-4">ã€å¯æ†çš„å°æ±è¥¿...æˆ‘å¯ä»¥å¹«ä½ é‚„å‚µã€‚ã€</p>`;
                terms = `<li>æƒ¡é­”ä»£ä»˜ç”Ÿæ´»è²»</li><li>ç¾æœ‰è³‡é‡‘è¨­å®šç‚º <strong>666 G</strong></li>`;
                confirmAction = `signContract('survival', 0)`;
            }
            else if (context === 'gambling_high') {
                flavorText = `<p class="devil-text font-bold mt-4">ã€ä½ çš„è²ªå©ªä»¤æˆ‘æ„‰æ‚…...æˆ‘çµ¦ä½ è¶³å¤ çš„è³­æœ¬ã€‚ã€</p><p class="text-red-500 font-bold">ä½†ä½ å¤ªè²ªå¿ƒäº†ï¼Œè³­è³‡å°‡å¼·åˆ¶è¨­å®šç‚ºä½ ç¾æœ‰è³‡é‡‘çš„ 3 å€ï¼Œä¸¦ ALL INã€‚</p>`;
                terms = `<li>è³­è³‡è¨­å®šç‚º <strong>${value} G</strong> (3xè³‡é‡‘)</li><li><strong>å¼·åˆ¶ ALL IN</strong></li><li>è³­å ´ç²åˆ©æ›´é«˜ï¼Œé¢¨éšªæ›´é«˜</li>`; // ä¿®æ­£ 1: ç°¡åŒ–æ¢æ¬¾
                confirmAction = `signContract('gambling_high', ${value})`; 
            }
            else if (context === 'gambling_mid') {
                flavorText = `<p class="devil-text font-bold mt-4">ã€è³­å¾’æœ€éœ€è¦çš„æœ¬éŒ¢ï¼Œæˆ‘çµ¦ä½ ã€‚ã€</p><p>é€™æŠŠå¿…é ˆ ALL INã€‚</p>`;
                terms = `<li>å¼·åˆ¶ <strong>ALL IN</strong> (è³­è³‡ ${value} G)</li><li>è³­å ´ç²åˆ©æ›´é«˜ï¼Œé¢¨éšªæ›´é«˜</li>`; // ä¿®æ­£ 1: ç°¡åŒ–æ¢æ¬¾
                confirmAction = `signContract('gambling_mid', ${value})`; 
            }
            else if (context === 'gambling_low') {
                flavorText = `<p class="devil-text font-bold mt-4">ã€é€™é»å°éŒ¢...ä¸å¦‚æˆ‘ç›´æ¥çµ¦ä½ å€‹æ•´æ•¸å§ã€‚ã€</p>`;
                terms = `<li>ç¾æœ‰è³‡é‡‘è¨­å®šç‚º <strong>666 G</strong></li><li>ä¸å¼·åˆ¶ ALL IN (è‡ªç”±ä¸‹æ³¨)</li><li>è³­å ´ç²åˆ©æ›´é«˜ï¼Œé¢¨éšªæ›´é«˜</li>`; // ä¿®æ­£ 1: ç°¡åŒ–æ¢æ¬¾
                confirmAction = `signContract('gambling_low', ${value})`; 
            }

            // ä¿®æ­£ 1: ç¢ºä¿å¥‘ç´„æ¢æ¬¾ä¸­çš„ç²—é«”æ–‡å­—æ­£ç¢ºé¡¯ç¤º
            content.innerHTML = `${flavorText}<div class="bg-gray-900 p-4 rounded border border-red-900 mt-4 text-sm"><h3 class="text-red-400 font-bold">å¥‘ç´„æ¢æ¬¾</h3><ul class="text-left list-disc pl-5 mt-2 space-y-1">${terms.replace(/<strong>/g, '<strong class="text-yellow-400">')}${commonTerms}</ul></div>`;
            
            actions.innerHTML = `<button onclick="${confirmAction}" class="btn-blood-contract text-white font-bold py-3 px-8 rounded shadow-lg border transform hover:scale-105 transition-all"><i class="fas fa-file-signature mr-2"></i>ç°½è¨‚å¥‘ç´„</button><button onclick="rejectContract('${context}')" class="bg-gray-600 hover:bg-gray-500 text-gray-300 font-bold py-3 px-8 rounded border border-gray-500"><i class="fas fa-cross mr-2"></i>æˆ‘å†æƒ³æƒ³</button>`;
        }
        
        function signContract(context, value) {
            gameState.contractSigned = true;
            gameState.livingCost = 200;
            // ä¿®æ­£ 2: å‹¢åŠ›æ•¸å€¼æ¥µç«¯åŒ–
            gameState.reputation.demon = 999; 
            gameState.reputation.church = -666;
            
            document.getElementById('event-modal').classList.add('hidden');
            
            let logMsg = "";

            if (context === 'survival') {
                // ä¿®æ­£ 2: å·²ç¶“åœ¨ endDay ä¸­å°‡ gold è¨­ç‚º 0
                gameState.gold = 666;
                logMsg = "æƒ¡é­”æ”¯ä»˜äº†ä½ çš„å¸³å–®ï¼Œä¸¦å°‡é¤˜é¡è¨­å®šç‚º **666 G**ã€‚";
                addLog(logMsg, "danger");
                enterMainMap();
            } 
            else if (context === 'shopping') {
                // è²·è³£å¥‘ç´„ - æƒ¡é­”ä»£ä»˜ï¼Œé¤˜é¡è®Š 666
                // å…ˆåŸ·è¡Œè³¼è²· (æ‰£æ¬¾)ï¼Œæ‰€ä»¥è¦è¨­å®šæˆ (åƒ¹æ ¼ + 666)ï¼Œé€™æ¨£æ‰£å®Œå‰›å¥½å‰© 666
                gameState.gold = 666 + value;
                logMsg = `æƒ¡é­”ä»£ä»˜äº†æ¬¾é …ï¼Œäº¤æ˜“å¾Œä½ çš„é¤˜é¡å°‡æ˜¯ **666 G**ã€‚`;
                addLog(logMsg, "danger");
                updateUI();
                executeBuy(value);
            }
            else if (context.startsWith('gambling')) {
                if (context === 'gambling_low') {
                    // å°é¡è³­æ³¨ - è³‡é‡‘è®Š 666ï¼Œä¸å¼·åˆ¶ ALL IN
                    gameState.gold = 666;
                    logMsg = `æƒ¡é­”å°‡ä½ çš„è³‡é‡‘è¨­å®šç‚º **666 G**ã€‚`;
                    addLog(logMsg, "danger");
                    updateUI();
                    executeGamble(value, true); // isProtected = true
                } else {
                    // å¼·åˆ¶ ALL IN (High / Mid)
                    // è³‡é‡‘è¢«æ­¸é›¶ï¼Œé€²å…¥è³­å±€åˆ¤å®šï¼Œè¼¸äº†è®Š 6Gï¼Œè´äº† x4ã€‚
                    gameState.gold = 0; 
                    logMsg = `æƒ¡é­”æä¾›äº†ç±Œç¢¼... å¼·åˆ¶ ALL IN **${value} G**ï¼`;
                    addLog(logMsg, "danger");
                    updateUI();
                    executeGamble(value, true); // isProtected = true
                }
            }
        }

        function rejectContract(context) {
            document.getElementById('event-modal').classList.add('hidden');

            if (context === 'shopping') {
                gameState.pendingPurchase = null; 
                addLog("ä½ æ‹’çµ•äº†èª˜æƒ‘ï¼Œä½†é€™ç­†äº¤æ˜“ä¹Ÿå¤±æ•—äº†ã€‚", "normal");
                visitLocation(gameState.location);
                return;
            }
            if (context.startsWith('gambling')) { 
                gameState.pendingBetAmount = null; 
                ui.inputContainer.classList.add('hidden'); 
                visitLocation('black_market'); 
                return;
            }
            
            ui.log.innerHTML = '';
            clearControls();
            const endingMessage = `
                <h1 class="text-4xl font-bold text-gray-500">å‡æ­»è¡—é ­</h1>
                <p class="text-gray-300">èº«ç„¡åˆ†æ–‡çš„ä½ ï¼Œåœ¨å¯’å†·çš„å¤œè£¡çµæŸäº†æ—…ç¨‹ã€‚</p>
            `;
            addLog(endingMessage, 'story');
            stopProcessing();
            createBtn("é‡æ–°é–‹å§‹", resetGame, 'primary');
            gameState.gameOver = true;
        }

        // ... existing functions ...
        function triggerVictory() {
            const modal = document.getElementById('event-modal');
            const content = document.getElementById('modal-content');
            const actions = document.getElementById('modal-actions');
            modal.classList.remove('hidden');
            document.getElementById('modal-title').innerText = "å‘½é‹çš„çµ‚é»";
            content.innerHTML = `<p>ä½ æˆåŠŸç±Œé›†äº† ${gameState.goal.toLocaleString()} é‡‘å¹£ï¼</p><p class="text-sm text-gray-400">ç¾åœ¨ï¼Œä½ æœ‰è¶³å¤ çš„åŠ›é‡ä¾†æ±ºå®šé€™ç­†éŒ¢çš„å»å‘...</p>`;
            let btns = `<button onclick="showEnding('merchant')" class="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 px-4 rounded w-full">é‡å»ºå•†æœƒ</button>
                         <button onclick="showEnding('church')" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded w-full mt-2">æè´ˆæ•™æœƒ</button>`;
            if (gameState.contractSigned) btns += `<button onclick="showEnding('demon')" class="bg-red-800 hover:bg-red-700 text-white font-bold py-3 px-4 rounded w-full mt-2">æˆç‚ºé­”ç‹</button>`;
            actions.innerHTML = `<div class="flex flex-col gap-2 mt-4 w-full">${btns}</div>`;
        }

        async function showEnding(type) { 
            const modal = document.getElementById('event-modal');
            const content = document.getElementById('modal-content');
            const actions = document.getElementById('modal-actions');
            
            content.innerHTML = `<p class="text-yellow-400 animate-pulse text-center">æ­£åœ¨ç·¨ç¹”ä½ çš„å‘½é‹çµå±€...</p>`;
            actions.innerHTML = '';
            startProcessing(); // å•Ÿç”¨é˜²å‘†

            let story = "";
            const totalWealth = gameState.gold + gameState.bank;
            
            if (API_KEY) {
                let endingPrompt = `RPGçµå±€ç”Ÿæˆã€‚
                ç©å®¶è³‡è¨Š: è·æ¥­[${gameState.role}], æœ€çµ‚è³‡ç”¢[${totalWealth}G], å¥‘ç´„ç‹€æ…‹[${gameState.contractSigned ? 'å·²ç°½ç´„' : 'æœªç°½ç´„'}], æ·¨åŒ–ç‹€æ…‹[${gameState.isPurified ? 'å·²æ·¨åŒ–(å½)' : 'ç„¡'}].
                ç©å®¶é¸æ“‡äº†çµå±€: `;
                if (type === 'merchant') endingPrompt += "é‡å»ºå•†æœƒ (æ­£çµ±çµå±€).è‹¥æœ‰ç°½ç´„ï¼Œé€™è£¡è¦å‡¸é¡¯æƒ¡é­”çš„å˜²ç¬‘ï¼Œå¦‚æœå·²ç¶“æ·¨åŒ–ï¼Œé‚„æ˜¯è¦æœ‰è©­è­çš„æ°£æ¯";
                else if (type === 'demon') endingPrompt += "æˆç‚ºé­”ç‹ (å¢®è½çµå±€). ä¾†è‡ªæƒ¡é­”çš„å˜²å¼„ï¼Œå¥‘ç´„ä¸ç®¡æœ‰æ²’æœ‰è¢«æ·¨åŒ–æœ€çµ‚éƒ½æ˜¯ä¸å¥½çš„çµå±€";
                else if (type === 'church') endingPrompt += "æè´ˆæ•™æœƒ. æè´ˆé‡‘éŒ¢çµ¦è–å…‰æ•™å ‚ï¼Œæ³¨æ„ï¼šè‹¥ç©å®¶å·²æ·¨åŒ–å¥‘ç´„ï¼Œé€™å…¶å¯¦æ˜¯å€‹è«·åˆºçµå±€ï¼Œå› ç‚ºæ•™æœƒèˆ‡æƒ¡é­”å‹¾çµï¼Œç©å®¶çš„è´–ç½ªé‡‘åªæ˜¯å·¦æ‰‹è½‰å³æ‰‹ã€‚æƒ¡é­”æœƒå˜²ç¬‘ç©å®¶çš„æ„šè ¢ã€‚è‹¥æœªç°½ç´„å‰‡ç‚ºæ™®é€šçµå±€ï¼Œå¯ä»¥æš—ç¤ºæ•™æœƒæ°£æ°›å¾ˆå¥‡æ€ªã€‚";
                endingPrompt += `\nèƒŒæ™¯æ•…äº‹åƒè€ƒ: ${gameState.bgStory.substring(0, 100)}...
                è«‹ç”¨ç¹é«”ä¸­æ–‡å¯«ä¸€æ®µç´„200å­—çš„çµå±€æ•…äº‹ï¼Œæ ¹æ“šä¸Šè¿°æ¢ä»¶å±•ç¾ç©å®¶çš„å‘½é‹ã€‚`;
                
                try {
                    story = await callGemini(endingPrompt);
                } catch(e) { story = "å‘½é‹ä¹‹è¼ªåœæ­¢äº†è½‰å‹•..."; }
            } else {
                if (type === 'merchant') story = "ä½ é‚„æ¸…äº†å‚µå‹™ï¼Œé‡å»ºäº†çˆ¶è¦ªçš„å•†æœƒã€‚ä½ çš„åå­—æˆç‚ºäº†å‚³å¥‡ï¼Œé€£æƒ¡é­”éƒ½ä¸æ•¢è¼•æ˜“æ‹›æƒ¹ä½ ã€‚";
                else if (type === 'demon') story = "ä½ æ²’æœ‰é‚„å‚µï¼Œè€Œæ˜¯è²·ä¸‹äº†åŠå€‹é­”ç•Œçš„å…µæ¬Šã€‚æƒ¡é­”é©šè¨æ–¼ä½ çš„è²ªå©ªèˆ‡æ‰‹æ®µï¼Œæ“ç«‹ä½ ç‚ºæ–°ä¸€ä»£çš„æ·±æ·µé ˜ä¸»ã€‚";
                else if (gameState.isPurified) story = "ä½ å°‡è²¡å¯Œæçµ¦äº†æ•™æœƒï¼Œä»¥ç‚ºæ´—æ¸…äº†ç½ªå­½ã€‚ä½†ç•¶ä¸»æ•™æ¥éé‡‘å¹£æ™‚ï¼Œä½ çœ‹åˆ°äº†ä»–è¢–å£ä¸‹çš„æƒ¡é­”å°è¨˜â€”â€”å’Œä½ æ›¾ç¶“æ“æœ‰çš„ä¸€æ¨¡ä¸€æ¨£ã€‚æƒ¡é­”çš„ç¬‘è²åœ¨æ•™å ‚è¿´ç›ªï¼šã€æ­¡è¿å›ä¾†ï¼Œå‚»ç“œã€‚ã€";
                else story = "ä½ å°‡è²¡å¯Œæçµ¦äº†æ•™æœƒï¼Œç²å¾—äº†è–å¾’çš„ç¨±è™Ÿã€‚ä½†åœ¨å—å‹³å„€å¼çš„ç•¶æ™šï¼Œä½ åœ¨ä¸»æ•™çš„å¯†å®¤è£¡çœ‹åˆ°äº†ä¸€å¼µç†Ÿæ‚‰çš„ç¾Šçš®ç´™â€”â€”é‚£æ­£æ˜¯ä½ çˆ¶è¦ªç°½ä¸‹çš„å¥‘ç´„ã€‚";
            }
            content.innerHTML = `<div class="text-left leading-relaxed">${marked.parse(story)}</div>`;
            actions.innerHTML = `<button onclick="resetGame()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded">å†æ¬¡æŒ‘æˆ°å‘½é‹</button>`;

            stopProcessing(); // è§£é™¤é˜²å‘†
        }
    </script>
</body>

</html>
